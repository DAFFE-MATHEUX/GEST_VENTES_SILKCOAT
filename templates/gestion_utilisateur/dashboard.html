{% extends "admin.html" %}
{% load static %}

{% block contents %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ===========================
     PAGE D'ACCUEIL ADMINISTRATION
     =========================== -->
<section class="content-header">
    {% if request.user.type_utilisateur != 'Gerante' %}
        <h1>TABLEAU DE BORD D'ADMINISTRATION</h1>
    {% else %}
        <h1>BIENVENUE DANS VOTRE ESPACE</h1>
    {% endif %}
    <ol class="breadcrumb">
        <li>
            <a href="{% url 'gestionUtilisateur:tableau_bord' %}">
                <i class="fa fa-dashboard"></i> Home
            </a>
        </li>
        <li class="active">Dashboard</li>
    </ol>
</section>

<section class="content">

<!-- =====================
     BO√éTES DE STATISTIQUES
     ===================== -->
<div class="row">
    <!-- Total cat√©gories produit -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-green">
            <div class="inner">
                <h3>{{ total_categories }}</h3>
                <p>Total Cat√©gories Produit</p>
            </div>
            <div class="icon"><i class="ion ion-pricetags"></i></div>
            <a href="{% url 'produits:listes_categorie' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Total produits -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-aqua">
            <div class="inner">
                <h3>{{ total_produits }}</h3>
                <p>Total Produits</p>
            </div>
            <div class="icon"><i class="ion ion-cube"></i></div>
            <a href="{% url 'produits:listes_produits' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Stock total -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_stock }}</h3>
                <p>Stock Total</p>
            </div>
            <div class="icon"><i class="ion ion-cube"></i></div>
            <a href="{% url 'produits:listes_produits_stock' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Ventes du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_ventes }}</h3>
                <p>Ventes (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-cash"></i></div>
            <a href="{% url 'produits:listes_des_ventes' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>


</div>

<!-- =====================
     COMMANDES / LIVRAISONS
     ===================== -->
<div class="row">
    <!-- Commandes du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-yellow">
            <div class="inner">
                <h3>{{ total_commandes }}</h3>
                <p>Commandes (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-bag"></i></div>
            <a href="{% url 'produits:listes_des_commandes' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Livraisons du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-yellow">
            <div class="inner">
                <h3>{{ total_livraisons }}</h3>
                <p>Livraisons (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-bag"></i></div>
            <a href="{% url 'produits:listes_des_livraisons' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

            <!-- D√©pnses du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_depenses }}</h3>
                <p>D√©penses (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-cash"></i></div>
            <a href="{% url 'liste_depense' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

</div>

<!-- =====================
     5 DERNI√àRES VENTES
     ===================== -->
<div class="row">
    <div class="col-xs-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">5 Derni√®res Ventes</h3>
            </div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code Vente</th>
                            <th>R√©f√©rence</th>
                            <th>Produit</th>
                            <th>Date</th>
                            <th>Qt√©</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vente in dernieres_ventes %}
                            {% for ligne in vente.lignes.all %}
                            <tr>
                                <td>{{ forloop.parentloop.counter }}.{{ forloop.counter }}</td>
                                <td>{{ vente.code }}</td>
                                <td>{{ ligne.produit.refprod }}</td>
                                <td>{{ ligne.produit.desgprod }}</td>
                                <td>{{ vente.date_vente|date:"d/m/Y H:i" }}</td>
                                <td>{{ ligne.quantite }}</td>
                                <td>{{ vente.total|floatformat:0 }} GNF</td>
                            </tr>
                            {% endfor %}
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Aucune vente r√©cente</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="text-center">Totaux : </td>
                            <td>{{ quantite_total_ventes }}</td>
                            <td>{{ montant_total_ventes|floatformat:0 }} GNF</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- =====================
     TOP 5 PRODUITS RENTABLES
     ===================== -->
<div class="row">
    <div class="col-xs-12">
        <div class="box box-warning">
            <div class="box-header with-border">
                <h3 class="box-title">üí∞ TOP 5 PRODUITS LES PLUS RENTABLES (Mois)</h3>
            </div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>R√©f</th>
                            <th>Cat√©gorie</th>
                            <th>Produit</th>
                            <th>Qt√©</th>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                                <th>B√©n√©fice</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in top_produits_rentables %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ p.produit__refprod }}</td>
                            <td>{{ p.produit__categorie__desgcategorie }}</td>
                            <td>{{ p.produit__desgprod }}</td>
                            <td>{{ p.qte_vendue }}</td>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <td class="text-success">
                                <strong>{{ p.benefice_total|floatformat:0 }} GNF</strong>
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Aucune donn√©e disponible</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-center">Totaux : </td>
                            <td>{{ total_quantite_vendu }}</td>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <td>{{ total_benefice|floatformat:0 }} GNF</td>
                            {% endif %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

{% if request.user.type_utilisateur != 'Gerante' %}

    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border"><h3 class="box-title">5 Derniers Audits</h3></div>
                <div class="box-body table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>#</th><th>Utilisateur</th><th>Action</th><th>Table concern√©e</th><th>Ancienne valeur</th><th>Nouvelle valeur</th><th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in derniers_audits %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{% if a.utilisateur %}{{ a.utilisateur.username }}{% else %}Utilisateur supprim√©{% endif %}</td>
                                <td>{{ a.action }}</td>
                                <td>{{ a.table_modifiee }}</td>
                                <td><pre>{{ a.ancienne_valeur|default:"-" }}</pre></td>
                                <td><pre>{{ a.nouvelle_valeur|default:"-" }}</pre></td>
                                <td>{{ a.date_action|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center">Aucune action enregistr√©e pour le moment.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endif %}

    {% comment %} Derni√®res Notifications {% endcomment %}
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border"><h3 class="box-title">5 Derni√®res Notifications</h3></div>
                <div class="box-body table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>#</th><th>Destinataire</th><th>Email</th><th>Titre</th><th>Message</th><th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for items in dernieeres_notification %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ items.destinataire }}</td>
                                <td>{{ items.destinataire_email }}</td>
                                <td>{{ items.titre }}</td>
                                <td>{{ items.message }}</td>
                                <td>{{ items.date|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center">Aucune notification r√©cente.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<!-- =====================
     GRAPHIQUES
     ===================== -->
<div class="row">
    <!-- Produits les plus vendus -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">üìä Produits les plus vendus (Mois)</h3>
            </div>
            <div class="box-body">
                <canvas id="chartTopProduits"></canvas>
            </div>
        </div>
    </div>

    {% if request.user.type_utilisateur != 'Gerante' %}
    <!-- Rentabilit√© mensuelle -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">üìä Rentabilit√© Mensuelle</h3>
            </div>
            <div class="box-body">
                <canvas id="chartRentabilite"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row">
    <!-- Comparaison Mois -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">üìä Comparaison Mois Actuel vs Mois Pr√©c√©dent</h3>
            </div>
            <div class="box-body">
                <canvas id="chartComparaisonMois"></canvas>
            </div>
        </div>
    </div>

    <!-- Courbe journali√®re -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">üìà Courbe Journali√®re du Mois</h3>
            </div>
            <div class="box-body">
                <canvas id="chartCourbeJour"></canvas>
            </div>
        </div>
    </div>
</div>

</section>

<!-- =====================
     SCRIPTS CHARTS
     ===================== -->
<script>
if ({{ labels_produits|length }} > 0) {
    new Chart(document.getElementById('chartTopProduits'), {
        type: 'bar',
        data: {
            labels: {{ labels_produits|safe }},
            datasets: [{
                label: 'Quantit√© vendue',
                data: {{ quantites_produits|safe }},
                backgroundColor: 'rgba(54,162,235,0.7)'
            }]
        },
        options: { responsive: true }
    });
}

{% if request.user.type_utilisateur != 'Gerante' %}
if ({{ labels_rentables|length }} > 0) {
    new Chart(document.getElementById('chartRentabilite'), {
        type: 'bar',
        data: {
            labels: {{ labels_rentables|safe }},
            datasets: [{
                label: 'B√©n√©fice (GNF)',
                data: {{ benefices|safe }},
                backgroundColor: 'rgba(40,167,69,0.7)'
            }]
        },
        options: { responsive: true }
    });
}
{% endif %}

if ({{ labels_mois|length }} > 0) {
    new Chart(document.getElementById('chartComparaisonMois'), {
        type: 'bar',
        data: {
            labels: {{ labels_mois|safe }},
            datasets: [
                {
                    label: 'Mois Pr√©c√©dent',
                    data: {{ data_mois_precedent|safe }},
                    backgroundColor: 'rgba(255,99,132,0.6)'
                },
                {
                    label: 'Mois Actuel',
                    data: {{ data_mois_actuel|safe }},
                    backgroundColor: 'rgba(54,162,235,0.6)'
                }
            ]
        },
        options: { responsive: true }
    });
}

if ({{ labels_jours|length }} > 0) {
    new Chart(document.getElementById('chartCourbeJour'), {
        type: 'line',
        data: {
            labels: {{ labels_jours|safe }},
            datasets: [{
                label: 'Ventes journali√®res',
                data: {{ ventes_journalieres|safe }},
                fill: false,
                borderColor: 'rgba(75,192,192,1)',
                tension: 0.2
            }]
        },
        options: { responsive: true }
    });
}
</script>

{% endblock %}
