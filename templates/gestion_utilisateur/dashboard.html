{% extends "admin.html" %}
{% load static %}

{% block contents %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ===========================
     PAGE D'ACCUEIL ADMINISTRATION
     =========================== -->
<section class="content-header">
    {% if not request.user.type_utilisateur == 'Gerante' %} 
    <h1>
        TABLEAU DE BORD D'ADMINISTRATION
    </h1>
    {% else %} 
    <h1>
        BIENVENUE DANS VOTRE ESPACE
    </h1>
    {% endif %}
    <ol class="breadcrumb">
        <li><a href="{% url 'gestionUtilisateur:tableau_bord' %}"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Dashboard</li>
    </ol>
</section>

<!-- ===========================
     CONTENU PRINCIPAL
     =========================== -->
<section class="content">

    <!-- =====================
         BO√éTES DE STATISTIQUES
         ===================== -->
    <div class="row">

        <div class="col-lg-3 col-xs-6">
            <div class="small-box bg-green">
                <div class="inner">
                    <h3>{{ total_categories }}</h3>
                    <p>Total Cat√©gories Produit</p>
                </div>
                <div class="icon">
                    <i class="ion ion-pricetags"></i>
                </div>
                <a href="{% url 'produits:listes_categorie' %}" class="small-box-footer">
                    Voir Plus <i class="fa fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>

        <div class="col-lg-3 col-xs-6">
            <div class="small-box bg-aqua">
                <div class="inner">
                    <h3>{{ total_produits }}</h3>
                    <p>Total Produits</p>
                </div>
                <div class="icon">
                    <i class="ion ion-cube"></i>
                </div>
                <a href="{% url 'produits:listes_produits' %}" class="small-box-footer">
                    Voir Plus <i class="fa fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>

           <div class="col-lg-3 col-xs-6">
            <div class="small-box bg-red">
                <div class="inner">
                    <h3>{{ total_stock_entrepot }}</h3>
                    <p>Total Stock Entrep√¥t</p>
                </div>
                <div class="icon">
                    <i class="ion ion-cash"></i>
                </div>
                <a href="{% url 'produits:listes_produits_stocks_entrepot' %}" class="small-box-footer">
                    Voir Plus <i class="fa fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>

        <div class="col-lg-3 col-xs-6">
            <div class="small-box bg-yellow">
                <div class="inner">
                    <h3>{{ total_stock_magasin }}</h3>
                    <p>Total Stock Magasin</p>
                </div>
                <div class="icon">
                    <i class="ion ion-bag"></i>
                </div>
                <a href="{% url 'produits:listes_produits_stock_magasin' %}" class="small-box-footer">
                    Voir Plus <i class="fa fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>


    </div>

        <div class="row">

        <div class="col-lg-3 col-xs-6">
            <div class="small-box bg-yellow">
                <div class="inner">
                    <h3>{{ total_commandes }}</h3>
                    <p>Total Commandes Par Semaine</p>
                </div>
                <div class="icon">
                    <i class="ion ion-bag"></i>
                </div>
                  {% if not request.user.type_utilisateur == 'Gerante' %} 
                <a href="{% url 'produits:listes_des_commandes' %}" class="small-box-footer">
                    Voir Plus <i class="fa fa-arrow-circle-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
               <div class="col-lg-3 col-xs-6">
            <div class="small-box bg-yellow">
                <div class="inner">
                    <h3>{{ total_livraisons }}</h3>
                    <p>Total Livraisons Par Semaine</p>
                </div>
                <div class="icon">
                    <i class="ion ion-bag"></i>
                </div>
                  {% if not request.user.type_utilisateur == 'Gerante' %} 
                <a href="{% url 'produits:listes_des_livraisons' %}" class="small-box-footer">
                    Voir Plus <i class="fa fa-arrow-circle-right"></i>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-3 col-xs-6">
            <div class="small-box bg-red">
                <div class="inner">
                    <h3>{{ total_ventes }}</h3>
                    <p>Total Ventes de la Semaine</p>
                </div>
                <div class="icon">
                    <i class="ion ion-cash"></i>
                </div>
                <a href="{% url 'produits:listes_des_ventes' %}" class="small-box-footer">
                    Voir Plus <i class="fa fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>


    </div>

    <!-- =====================
         DERNIERS VENTES
         ===================== -->
<div class="row">
    <div class="col-md-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">5 Derni√®res Ventes</h3>
            </div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code Vente</th>
                            <th>R√©f√©rence Produit</th>
                            <th>Produit</th>
                            <th>Date</th>
                            <th>Quantit√© Vendue</th>
                            <th>Total Vente</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vente in dernieres_ventes %}
                            {% for ligne in vente.lignes.all %}
                            <tr>
                                <td>{{ forloop.parentloop.counter }}.{{ forloop.counter }}</td>
                                <td>{{ vente.code }}</td>
                                <td>{{ ligne.produit.refprod }}</td>
                                <td>{{ ligne.produit.desgprod }}</td>
                                <td>{{ vente.date_vente|date:"d/m/Y H:i" }}</td>
                                <td>{{ ligne.quantite }}</td>
                                <td>{{ vente.total|floatformat:0 }} GNF</td>
                            </tr>
                            {% endfor %}
                        {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">Aucune vente r√©cente.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


    <!-- ==============================================
         LES PRODUITS LES PLUS VENDUS CETTE SEMEMAINE
         ===================== ========================-->
 <div class="row">
    <div class="col-md-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">
                    LES 5 PRODUITS LES PLUS VENDUS CETTE SEMAINE
                </h3>
            </div>

            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>R√©f√©rence Produit</th>
                            <th>Cat√©gorie</th>
                            <th>D√©signation</th>
                            <th>Quantit√© Vendue</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for elem in produits_plus_vendus %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ elem.produit__refprod }}</td>
                                <td>{{ elem.produit__categorie__desgcategorie }}</td>
                                <td>{{ elem.produit__desgprod }}</td>
                                <td>
                                    <strong>{{ elem.qte_totale }}</strong>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">
                                    Aucune vente enregistr√©e cette semaine.
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box box-warning">
            <div class="box-header with-border">
                <h3 class="box-title">
                    üí∞ TOP 5 PRODUITS LES PLUS RENTABLES (SEMAINE)
                </h3>
            </div>

            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>R√©f√©rence</th>
                            <th>Cat√©gorie</th>
                            <th>Produit</th>
                            <th>Quantit√© vendue</th>
                            <th>B√©n√©fice total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in top_produits_rentables %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ p.produit__refprod }}</td>
                            <td>{{ p.produit__categorie__desgcategorie }}</td>
                            <td>{{ p.produit__desgprod }}</td>
                            <td>{{ p.qte_vendue }}</td>
                            <td>
                                <strong class="text-success">
                                    {{ p.benefice_total|floatformat:0 }} GNF
                                </strong>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">
                                Aucun produit rentable cette semaine.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">
                    üìä Rentabilit√© des produits (Top 5)
                </h3>
            </div>
            <div class="box-body">
                <canvas id="chartRentabilite" height="100"></canvas>
            </div>
        </div>
    </div>
</div>



<div class="row">
    <div class="col-md-12">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">
                    üìä Top 5 Produits les plus vendus cette semaine
                </h3>
            </div>

            <div class="box-body">
                <canvas id="chartTopProduits" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

    <!-- =====================
         3 DERNIERES COMMANDES
         ===================== -->
   <div class="row">
    <div class="col-md-12">
        <div class="box box-info">
            <div class="box-header with-border"><h3 class="box-title">3 Derni√®res Commandes</h3></div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Num Commande</th>
                            <th>R√©f Produit</th>
                            <th>D√©signation</th>
                            <th>Qte Command√©e</th>
                            <th>Statut Command√©</th>
                            <th>Prix Unitaire</th>
                            <th>Cat√©gorie</th>
                            <th>Date Commande</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for elem in listes_commandes %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ elem.numcmd }}</td>
                                <td>{{ elem.produits.refprod }}</td>
                                <td>{{ elem.produits.desgprod }}</td>
                                <td>{{ elem.qtecmd }}</td>
                                <td>{{ elem.statuts }}</td>
                                <td>{{ elem.produits.pu }}</td>
                                <td>{{ elem.produits.categorie.desgcategorie }}</td>
                                <td>{{ elem.datecmd|date:'d/m/Y' }}</td>
                            </tr>
                        {% empty %}
                        <tr><td colspan="8" class="text-center">Aucune commande r√©cente.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

    <!-- =====================
         3 DERNIERES LIVRAISONS
         ===================== -->
   <div class="row">
    <div class="col-md-12">
        <div class="box box-info">
            <div class="box-header with-border"><h3 class="box-title">3 Derni√®res Livraisons</h3></div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Num Livraison</th>
                            <th>Num Commande</th>
                            <th>Cat√©gorie</th>
                            <th>D√©signation</th>
                            <th>Qte Command√©e</th>
                            <th>Qte Livr√©e</th>
                            <th>Qte Restante</th>
                            <th>Date Livraison</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for elem in listes_livraisons %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ elem.numlivrer }}</td>
                                <td>{{ elem.commande.numcmd }}</td>
                                <td>{{ elem.produits.categorie.desgcategorie }}</td>
                                <td>{{ elem.produits.desgprod }}</td>
                                <td>{{ elem.commande.qtecmd }}</td>
                                <td>{{ elem.total_livree }}</td>
                                <td>{{ elem.qte_restante }}</td>
                                <td>{{ elem.datelivrer|date:'d/m/Y' }}</td>
                            </tr>
                        {% empty %}
                        <tr><td colspan="8" class="text-center">Aucune livraisons r√©cente.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

    <!-- =====================
         DERNIERS AUDITS
         ===================== -->
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border"><h3 class="box-title">3 Derniers Audits</h3></div>
                <div class="box-body table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>#</th><th>Utilisateur</th><th>Action</th><th>Table concern√©e</th><th>Ancienne valeur</th><th>Nouvelle valeur</th><th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in derniers_audits %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{% if a.utilisateur %}{{ a.utilisateur.username }}{% else %}Utilisateur supprim√©{% endif %}</td>
                                <td>{{ a.action }}</td>
                                <td>{{ a.table_modifiee }}</td>
                                <td><pre>{{ a.ancienne_valeur|default:"-" }}</pre></td>
                                <td><pre>{{ a.nouvelle_valeur|default:"-" }}</pre></td>
                                <td>{{ a.date_action|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center">Aucune action enregistr√©e pour le moment.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- =====================
         DERNI√àRES NOTIFICATIONS
         ===================== -->
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border"><h3 class="box-title">5 Derni√®res Notifications</h3></div>
                <div class="box-body table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>#</th><th>Destinataire</th><th>Email</th><th>Titre</th><th>Message</th><th>Lu</th><th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for n in dernieeres_notification %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ n.destinataire }}</td>
                                <td>{{ n.destinataire_email }}</td>
                                <td>{{ n.titre }}</td>
                                <td>{{ n.message }}</td>
                                <td>{{ n.lu|yesno:"Oui,Non" }}</td>
                                <td>{{ n.date|date:"d/m/Y" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center">Aucune notification r√©cente.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</section>

<script>
const ctx = document.getElementById('chartTopProduits').getContext('2d');

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ labels_produits|safe }},
        datasets: [{
            label: 'Quantit√© vendue',
            data: {{ quantites_produits|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>

<script>
const ctxRent = document.getElementById('chartRentabilite').getContext('2d');

new Chart(ctxRent, {
    type: 'bar',
    data: {
        labels: {{ labels_rentables|safe }},
        datasets: [{
            label: 'B√©n√©fice (GNF)',
            data: {{ benefices|safe }},
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>

{% endblock %}
