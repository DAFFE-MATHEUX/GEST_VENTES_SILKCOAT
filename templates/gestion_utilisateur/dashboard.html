{% extends "admin.html" %}
{% load static %}

{% block contents %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ===========================
     PAGE D'ACCUEIL ADMINISTRATION
     =========================== -->
<section class="content-header">
    {% if request.user.type_utilisateur != 'Gerante' %}
        <h1>TABLEAU DE BORD D'ADMINISTRATION</h1>
    {% else %}
        <h1>BIENVENUE DANS VOTRE ESPACE</h1>
    {% endif %}
    <ol class="breadcrumb">
        <li>
            <a href="{% url 'gestionUtilisateur:tableau_bord' %}">
                <i class="fa fa-dashboard"></i> Home
            </a>
        </li>
        <li class="active">Dashboard</li>
    </ol>
</section>

<section class="content">

<!-- =====================
     BOÃŽTES DE STATISTIQUES
     ===================== -->
<div class="row">
    <!-- Total catÃ©gories produit -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-green">
            <div class="inner">
                <h3>{{ total_categories }}</h3>
                <p>Total CatÃ©gories Produit</p>
            </div>
            <div class="icon"><i class="ion ion-pricetags"></i></div>
            <a href="{% url 'produits:listes_categorie' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Total produits -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-aqua">
            <div class="inner">
                <h3>{{ total_produits }}</h3>
                <p>Total Produits</p>
            </div>
            <div class="icon"><i class="ion ion-cube"></i></div>
            <a href="{% url 'produits:listes_produits' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Stock total -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_stock }}</h3>
                <p>Stock Total</p>
            </div>
            <div class="icon"><i class="ion ion-cube"></i></div>
            <a href="{% url 'produits:listes_produits_stock' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Ventes du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_ventes }}</h3>
                <p>Ventes (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-cash"></i></div>
            <a href="{% url 'produits:listes_des_ventes' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- =====================
     COMMANDES / LIVRAISONS
     ===================== -->
<div class="row">
    <!-- Commandes du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-yellow">
            <div class="inner">
                <h3>{{ total_commandes }}</h3>
                <p>Commandes (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-bag"></i></div>
            <a href="{% url 'produits:listes_des_commandes' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Livraisons du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-yellow">
            <div class="inner">
                <h3>{{ total_livraisons }}</h3>
                <p>Livraisons (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-bag"></i></div>
            <a href="{% url 'produits:listes_des_livraisons' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- =====================
     5 DERNIÃˆRES VENTES
     ===================== -->
<div class="row">
    <div class="col-xs-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">5 DerniÃ¨res Ventes</h3>
            </div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code Vente</th>
                            <th>RÃ©fÃ©rence</th>
                            <th>Produit</th>
                            <th>Date</th>
                            <th>QtÃ©</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vente in dernieres_ventes %}
                            {% for ligne in vente.lignes.all %}
                            <tr>
                                <td>{{ forloop.parentloop.counter }}.{{ forloop.counter }}</td>
                                <td>{{ vente.code }}</td>
                                <td>{{ ligne.produit.refprod }}</td>
                                <td>{{ ligne.produit.desgprod }}</td>
                                <td>{{ vente.date_vente|date:"d/m/Y H:i" }}</td>
                                <td>{{ ligne.quantite }}</td>
                                <td>{{ vente.total|floatformat:0 }} GNF</td>
                            </tr>
                            {% endfor %}
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Aucune vente rÃ©cente</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- =====================
     TOP 5 PRODUITS RENTABLES
     ===================== -->
<div class="row">
    <div class="col-xs-12">
        <div class="box box-warning">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ’° TOP 5 PRODUITS LES PLUS RENTABLES (Mois)</h3>
            </div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>RÃ©f</th>
                            <th>CatÃ©gorie</th>
                            <th>Produit</th>
                            <th>QtÃ©</th>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                                <th>BÃ©nÃ©fice</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in top_produits_rentables %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ p.produit__refprod }}</td>
                            <td>{{ p.produit__categorie__desgcategorie }}</td>
                            <td>{{ p.produit__desgprod }}</td>
                            <td>{{ p.qte_vendue }}</td>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <td class="text-success">
                                <strong>{{ p.benefice_total|floatformat:0 }} GNF</strong>
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Aucune donnÃ©e disponible</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- =====================
     GRAPHIQUES
     ===================== -->
<div class="row">
    <!-- Produits les plus vendus -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“Š Produits les plus vendus (Mois)</h3>
            </div>
            <div class="box-body">
                <canvas id="chartTopProduits"></canvas>
            </div>
        </div>
    </div>

    {% if request.user.type_utilisateur != 'Gerante' %}
    <!-- RentabilitÃ© mensuelle -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“Š RentabilitÃ© Mensuelle</h3>
            </div>
            <div class="box-body">
                <canvas id="chartRentabilite"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row">
    <!-- Comparaison Mois -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“Š Comparaison Mois Actuel vs Mois PrÃ©cÃ©dent</h3>
            </div>
            <div class="box-body">
                <canvas id="chartComparaisonMois"></canvas>
            </div>
        </div>
    </div>

    <!-- Courbe journaliÃ¨re -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“ˆ Courbe JournaliÃ¨re du Mois</h3>
            </div>
            <div class="box-body">
                <canvas id="chartCourbeJour"></canvas>
            </div>
        </div>
    </div>
</div>

</section>

<!-- =====================
     SCRIPTS CHARTS
     ===================== -->
<script>
if ({{ labels_produits|length }} > 0) {
    new Chart(document.getElementById('chartTopProduits'), {
        type: 'bar',
        data: {
            labels: {{ labels_produits|safe }},
            datasets: [{
                label: 'QuantitÃ© vendue',
                data: {{ quantites_produits|safe }},
                backgroundColor: 'rgba(54,162,235,0.7)'
            }]
        },
        options: { responsive: true }
    });
}

{% if request.user.type_utilisateur != 'Gerante' %}
if ({{ labels_rentables|length }} > 0) {
    new Chart(document.getElementById('chartRentabilite'), {
        type: 'bar',
        data: {
            labels: {{ labels_rentables|safe }},
            datasets: [{
                label: 'BÃ©nÃ©fice (GNF)',
                data: {{ benefices|safe }},
                backgroundColor: 'rgba(40,167,69,0.7)'
            }]
        },
        options: { responsive: true }
    });
}
{% endif %}

if ({{ labels_mois|length }} > 0) {
    new Chart(document.getElementById('chartComparaisonMois'), {
        type: 'bar',
        data: {
            labels: {{ labels_mois|safe }},
            datasets: [
                {
                    label: 'Mois PrÃ©cÃ©dent',
                    data: {{ data_mois_precedent|safe }},
                    backgroundColor: 'rgba(255,99,132,0.6)'
                },
                {
                    label: 'Mois Actuel',
                    data: {{ data_mois_actuel|safe }},
                    backgroundColor: 'rgba(54,162,235,0.6)'
                }
            ]
        },
        options: { responsive: true }
    });
}

if ({{ labels_jours|length }} > 0) {
    new Chart(document.getElementById('chartCourbeJour'), {
        type: 'line',
        data: {
            labels: {{ labels_jours|safe }},
            datasets: [{
                label: 'Ventes journaliÃ¨res',
                data: {{ ventes_journalieres|safe }},
                fill: false,
                borderColor: 'rgba(75,192,192,1)',
                tension: 0.2
            }]
        },
        options: { responsive: true }
    });
}
</script>

{% endblock %}
