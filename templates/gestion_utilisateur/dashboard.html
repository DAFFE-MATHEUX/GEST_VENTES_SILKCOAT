{% extends "admin.html" %}
{% load static %}

{% block contents %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ===========================
     PAGE D'ACCUEIL ADMINISTRATION
     =========================== -->
<section class="content-header">
    {% if request.user.type_utilisateur != 'Gerante' %}
        <h1>TABLEAU DE BORD D'ADMINISTRATION</h1>
    {% else %}
        <h1>BIENVENUE DANS VOTRE ESPACE</h1>
    {% endif %}
    <ol class="breadcrumb">
        <li>
            <a href="{% url 'gestionUtilisateur:tableau_bord' %}">
                <i class="fa fa-dashboard"></i> Home
            </a>
        </li>
        <li class="active">Dashboard</li>
    </ol>
</section>

<section class="content">

<!-- =====================
     BOÃŽTES DE STATISTIQUES
     ===================== -->
<div class="row">
    <!-- Total catÃ©gories produit -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-green">
            <div class="inner">
                <h3>{{ total_categories }}</h3>
                <p>Total CatÃ©gories Produit</p>
            </div>
            <div class="icon"><i class="ion ion-pricetags"></i></div>
            <a href="{% url 'produits:listes_categorie' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Total produits -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-aqua">
            <div class="inner">
                <h3>{{ total_produits }}</h3>
                <p>Total Produits</p>
            </div>
            <div class="icon"><i class="ion ion-cube"></i></div>
            <a href="{% url 'produits:listes_produits' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Stock total -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_stock }}</h3>
                <p>Stock Total</p>
            </div>
            <div class="icon"><i class="ion ion-cube"></i></div>
            <a href="{% url 'produits:listes_produits_stock' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Ventes du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_ventes }}</h3>
                <p>Ventes (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-cash"></i></div>
            <a href="{% url 'produits:listes_des_ventes' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>


</div>

<!-- =====================
     COMMANDES / LIVRAISONS
     ===================== -->
<div class="row">
    <!-- Commandes du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-yellow">
            <div class="inner">
                <h3>{{ total_commandes }}</h3>
                <p>Commandes (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-bag"></i></div>
            <a href="{% url 'produits:listes_des_commandes' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- Livraisons du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-yellow">
            <div class="inner">
                <h3>{{ total_livraisons }}</h3>
                <p>Livraisons (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-bag"></i></div>
            <a href="{% url 'produits:listes_des_livraisons' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

            <!-- DÃ©pnses du mois -->
    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12 mb-2">
        <div class="small-box bg-red">
            <div class="inner">
                <h3>{{ total_depenses }}</h3>
                <p>DÃ©penses (Mois)</p>
            </div>
            <div class="icon"><i class="ion ion-cash"></i></div>
            <a href="{% url 'liste_depense' %}" class="small-box-footer">
                Voir Plus <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

</div>

<!-- =====================
     5 DERNIÃˆRES VENTES
     ===================== -->
<div class="row">
    <div class="col-xs-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">5 DerniÃ¨res Ventes</h3>
            </div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code Vente</th>
                            <th>Vendu Par</th>
                            <th>Clients</th>
                            <th>Date</th>
                            <th>Qte</th>
                            <th>Total</th>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <th>BÃ©nÃ©fice</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for vente in dernieres_ventes %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ vente.code }}</td>
                                <td>{{ vente.utilisateur.get_full_name|default:"Administrateur" }}</td>
                                <td> {{ vente.nom_complet_client }}</td>
                                <td>{{ vente.date_vente|date:"d/m/Y H:i" }}</td>
                                <td>{{ vente.total_quanite }}</td>
                                <td>{{ vente.total|floatformat:0 }} GNF</td>
                                {% if request.user.type_utilisateur != 'Gerante' %}
                                <td>{{ vente.benefice_total }}</td>
                                {% endif %}
                            </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">Aucune vente rÃ©cente</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="text-center">Totaux : </td>
                            <td>{{ quantite_total_ventes }}</td>
                            <td>{{ montant_total_ventes|floatformat:0 }} GNF</td>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <td>{{ montant_total_benefice|floatformat:0 }} GNF</td>
                            {% endif %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- =====================
     TOP 5 PRODUITS RENTABLES
     ===================== -->
<div class="row">
    <div class="col-xs-12">
        <div class="box box-warning">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ’° TOP 5 PRODUITS LES PLUS RENTABLES (Mois)</h3>
            </div>
            <div class="box-body table-responsive">
                <table class="table table-bordered table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>RÃ©f</th>
                            <th>CatÃ©gorie</th>
                            <th>Produit</th>
                            <th>QtÃ©</th>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                                <th>BÃ©nÃ©fice</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in top_produits_rentables %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ p.produit__refprod }}</td>
                            <td>{{ p.produit__categorie__desgcategorie }}</td>
                            <td>{{ p.produit__desgprod }}</td>
                            <td>{{ p.qte_vendue }}</td>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <td class="text-success">
                                <strong>{{ p.benefice_total|floatformat:0 }} GNF</strong>
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Aucune donnÃ©e disponible</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-center">Totaux : </td>
                            <td>{{ total_quantite_vendu }}</td>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <td>{{ total_benefice|floatformat:0 }} GNF</td>
                            {% endif %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

{% if request.user.type_utilisateur != 'Gerante' %}

    {% comment %} DerniÃ¨res Notifications {% endcomment %}
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border"><h3 class="box-title">5 DerniÃ¨res Notifications</h3></div>
                <div class="box-body table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>#</th><th>Destinataire</th><th>Email</th><th>Titre</th><th>Message</th><th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for items in dernieeres_notification %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ items.destinataire }}</td>
                                <td>{{ items.destinataire_email }}</td>
                                <td>{{ items.titre }}</td>
                                <td>{{ items.message }}</td>
                                <td>{{ items.date|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center">Aucune notification rÃ©cente.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endif %}
<!-- =====================
     GRAPHIQUES
     ===================== -->
<div class="row">
    <!-- Produits les plus vendus -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“Š 5 Produits les plus vendus (Mois)</h3>
            </div>
            <div class="box-body">
                <canvas id="chartTopProduits"></canvas>
            </div>
        </div>
    </div>

    {% if request.user.type_utilisateur != 'Gerante' %}
    <!-- RentabilitÃ© mensuelle -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“Š Top 5 RentabilitÃ© Mensuelle </h3>
            </div>
            <div class="box-body">
                <canvas id="chartRentabilite"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>
 
<div class="row">
    <!-- Comparaison Mois -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“Š Comparaison Hier vs Aujourdâ€™hui </h3>
            </div>
            <div class="box-body">
                <canvas id="chartComparaisonJour"></canvas>
            </div>
        </div>
    </div>

    <!-- Courbe journaliÃ¨re -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“ˆ Comparaison entre Les Semaines</h3>
            </div>
            <div class="box-body">
                <canvas id="chartComparaisonSemaine"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Comparaison Mois -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“Š Comparaison Mois Actuel vs Mois PrÃ©cÃ©dent</h3>
            </div>
            <div class="box-body">
                <canvas id="chartComparaisonMois"></canvas>
            </div>
        </div>
    </div>

    <!-- Courbe journaliÃ¨re -->
    <div class="col-md-6 col-xs-12 mb-3">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">ðŸ“ˆ Courbe JournaliÃ¨re du Mois</h3>
            </div>
            <div class="box-body">
                <canvas id="chartCourbeJour"></canvas>
            </div>
        </div>
    </div>
</div>

</section>

<!-- =====================
     SCRIPTS CHARTS
     ===================== -->
<script>
/* =====================
   VARIABLES SÃ‰CURISÃ‰ES
   ===================== */
const labelsProduits = {{ labels_produits|default:"[]"|safe }};
const quantitesProduits = {{ quantites_produits|default:"[]"|safe }};

const labelsRentables = {{ labels_rentables|default:"[]"|safe }};
const benefices = {{ benefices|default:"[]"|safe }};

const labelsJour = {{ labels_jour_comparaison|default:"[]"|safe }};
const dataJourHier = {{ data_jour_hier|default:"[]"|safe }};
const dataJourAuj = {{ data_jour_aujourdhui|default:"[]"|safe }};

const labelsSemaine = {{ labels_semaine|default:"[]"|safe }};
const dataSemainePrec = {{ data_semaine_precedente|default:"[]"|safe }};
const dataSemaineAct = {{ data_semaine_actuelle|default:"[]"|safe }};

const labelsMois = {{ labels_mois|default:"[]"|safe }};
const dataMoisPrec = {{ data_mois_precedent|default:"[]"|safe }};
const dataMoisAct = {{ data_mois_actuel|default:"[]"|safe }};

const labelsJours = {{ labels_jours|default:"[]"|safe }};
const ventesJournalieres = {{ ventes_journalieres|default:"[]"|safe }};


/* =============================
   TOP 5 DES PRODUITS VENDUS
   ============================= */
if (labelsProduits.length > 0) {
    new Chart(document.getElementById('chartTopProduits'), {
        type: 'bar',
        data: {
            labels: labelsProduits,
            datasets: [{
                label: 'QuantitÃ© vendue',
                data: quantitesProduits,
                backgroundColor: 'rgba(54,162,235,0.7)'
            }]
        },
        options: { responsive: true }
    });
}


/* ================================
   TOP RENTABILITÃ‰ DES VENTES
   ================================ */
{% if request.user.type_utilisateur != 'Gerante' %}
if (labelsRentables.length > 0) {
    new Chart(document.getElementById('chartRentabilite'), {
        type: 'bar',
        data: {
            labels: labelsRentables,
            datasets: [{
                label: 'BÃ©nÃ©fice (GNF)',
                data: benefices,
                backgroundColor: 'rgba(40,167,69,0.7)'
            }]
        },
        options: { responsive: true }
    });
}
{% endif %}


/* =================================================
   COMPARAISON DES VENTES ENTRE HIER ET AUJOURD'HUI
   ================================================= */
if (labelsJour.length > 0) {
    new Chart(document.getElementById('chartComparaisonJour'), {
        type: 'bar',
        data: {
            labels: labelsJour,
            datasets: [
                {
                    label: 'Hier',
                    data: dataJourHier,
                    backgroundColor: 'rgba(255,159,64,0.7)'
                },
                {
                    label: 'Aujourdâ€™hui',
                    data: dataJourAuj,
                    backgroundColor: 'rgba(75,192,192,0.7)'
                }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}


/* =============================================================
   COMPARAISON DES VENTES ENTRE LA SEMAINE DERNIERE ET ACTUELLE
   ============================================================= */
if (labelsSemaine.length > 0) {
    new Chart(document.getElementById('chartComparaisonSemaine'), {
        type: 'bar',
        data: {
            labels: labelsSemaine,
            datasets: [
                {
                    label: 'Semaine PrÃ©cÃ©dente',
                    data: dataSemainePrec,
                    backgroundColor: 'rgba(153,102,255,0.7)'
                },
                {
                    label: 'Semaine Actuelle',
                    data: dataSemaineAct,
                    backgroundColor: 'rgba(54,162,235,0.7)'
                }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}


/* =======================================
   COMPARAISON DES VENTES ENTRE LES MOIS
   ======================================= */
if (labelsMois.length > 0) {
    new Chart(document.getElementById('chartComparaisonMois'), {
        type: 'bar',
        data: {
            labels: labelsMois,
            datasets: [
                {
                    label: 'Ventes (GNF)',
                    data: [dataMoisPrec[0], dataMoisAct[0]],
                    backgroundColor: [
                        'rgba(255,99,132,0.7)',
                        'rgba(54,162,235,0.7)'
                    ]
                }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}


/* =====================
   COURBE JOURNALIÃˆRE
   ===================== */
if (labelsJours.length > 0) {
    new Chart(document.getElementById('chartCourbeJour'), {
        type: 'line',
        data: {
            labels: labelsJours,
            datasets: [{
                label: 'Ventes journaliÃ¨res',
                data: ventesJournalieres,
                borderColor: 'rgba(75,192,192,1)',
                tension: 0.3,
                fill: false
            }]
        },
        options: { responsive: true }
    });
}
</script>


{% endblock %}
