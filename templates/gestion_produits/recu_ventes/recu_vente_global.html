{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Facture - {{ entreprise.nom_entreprise }}</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">

    <style>
        /* ====== RÉGLAGES A4 / PDF (TRÈS IMPORTANT) ====== */
        @page {
            size: A4;
            margin: 5mm 8mm;   /* haut | droite-gauche | bas */
        }

        body {
            background: #fff;
            font-family: "Poppins", sans-serif;
            color: #222;
            margin: 0;
            padding: 0;
        }

        /* ====== CONTENEUR FACTURE ====== */
        .recu-container {
            background: white;
            max-width: 1000px;
            margin: 2px auto;          /* espace externe réduit */
            padding: 8px 18px 12px;    /* espace interne haut réduit */
            border: 1px solid #000;
        }

        /* ====== ENTÊTE ====== */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 2px;
            margin-bottom: 2px;
        }

        .header-left, .header-right {
            font-size: 11px;
            line-height: 1.3;
            width: 30%;
        }

        .header-center {
            text-align: center;
            width: 40%;

        }

        .header-center h2 {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 15px;
            margin: 2px  0;
        }

        .logo {
            max-width: 160px;
            max-height: 120px;
            object-fit: contain;
        }

        /* ====== TITRE ====== */
        .facture-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #000;
            padding: 4px;
            margin: 13px 0;
        }

        /* ====== TABLEAUX ====== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #000;
            padding: 3px 3px;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        th {
            background: #e9ecef;
        }

        td.text-center { text-align: center; }
        td.text-end { text-align: right; }

        /* Colonne # */
        .col-num {
            width: 28px;
            min-width: 28px;
            max-width: 28px;
            text-align: center;
            padding: 2px 0;
        }

        /* Désignation produit */
        .col-designation {
            white-space: normal !important;
            word-wrap: break-word;
            overflow: visible;
            line-height: 1.3;
        }

        tfoot tr {
            font-weight: bold;
            background-color: #f1f3f5;
        }

        /* ====== TOTAL ====== */
        .total-box {
            font-size: 15px;
            font-weight: bold;
            text-align: right;
            color: #0d6efd;
        }

        /* ====== FOOTER ====== */
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-top: 5px;
            margin-top: 5px;
            font-size: 11px;
            line-height: 1.3;
        }

        .footer-left img {
            max-height: 45px;
            margin-bottom: 3px;
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            tr { page-break-inside: avoid; }
        }
    </style>
</head>

<body>
<div class="recu-container">

    <!-- ====== ENTÊTE ====== -->
    <div class="header-top">
        <div class="header-left">
            <strong>{{ entreprise.nom_entreprise|upper }}</strong><br>
            {{ entreprise.adresse|default:"" }}<br>
            Tél : {{ entreprise.contact1|default:"-" }}<br>
            {% if entreprise.contact2 %}{{ entreprise.contact2 }}<br>{% endif %}
            Email : {{ entreprise.email|default:"-" }}
        </div>

        <div class="header-center">
            {% if entreprise.logo %}
                <img src="{{ entreprise.logo.url }}" class="logo"><br>
            {% endif %}
            <h2>{{ entreprise.nom_entreprise }}</h2>
        </div>

        <div class="header-right text-right">
            {% if qr_code_base64 %}
                <img src="data:image/png;base64,{{ qr_code_base64 }}" width="75" height="75">
            {% endif %}
        </div>
    </div>

    <!-- ====== TITRE ====== -->
    <div class="facture-title">FACTURE DE VENTES</div>

    <!-- ====== INFOS FACTURE ====== -->
    <table>
        <tr>
            <th>Numéro Facture</th>
            <td>{{ vente.code }}</td>
            <th>Date</th>
            <td>{{ vente.date_vente|date:"d/m/Y" }}</td>
        </tr>
        <tr>
            <th>Vendu par</th>
            <td>{{ vente.utilisateur.get_full_name|default:"Administrateur" }}</td>
            <th>Mode paiement</th>
            <td>Comptant</td>
        </tr>
    </table>

    <!-- ====== CLIENT ====== -->
    <table>
        <tr>
            <th>Client</th>
            <td>{{ vente.nom_complet_client }}</td>
        </tr>
        <tr>
            <th>Adresse / Contact</th>
            <td>{{ vente.adresseclt_client|default:"-" }} {{ vente.telclt_client|default:"-" }}</td>
        </tr>
    </table>

    <!-- ====== PRODUITS ====== -->
    <table>
        <thead>
            <tr>
                <th class="col-num">#</th>
                <th>Catégorie</th>
                <th class="col-designation">Désignation Produit</th>
                <th class="text-center">Qté(s)</th>
                {% if has_retour %}
                <th class="text-center">Qté Ret.</th>
                {% endif %}
                <th class="text-center">PU de Vente</th>
                <th class="text-center">Réduc.</th>
                <th class="text-center">Total</th>
            </tr>
        </thead>

        <tbody>
            {% for l in lignes %}
            <tr>
                <td class="col-num">{{ forloop.counter }}</td>
                <td>{{ l.produit.categorie.desgcategorie }}</td>
                <td class="col-designation">{{ l.produit.desgprod }}</td>
                <td class="text-center">{{ l.quantite }}</td>

                {% if has_retour %}
                <td class="text-center">
                    {% for ret in l.retours.all %}
                        {{ ret.quantite_retour }} {% if not forloop.last %} , {% endif %}
                    {% empty %}-{% endfor %}
                </td>
                {% endif %}

                <td class="text-end">{{ l.prix|floatformat:0 }}</td>
                <td class="text-end">{{ l.montant_reduction|floatformat:0 }}</td>
                <td class="text-end">{{ l.sous_total|floatformat:0 }}</td>
            </tr>
            {% endfor %}
        </tbody>

        <tfoot>
            <tr>
                <th colspan="3" class="text-center">Totaux</th>
                <th class="text-center">{{ total_quantite|floatformat:0 }}</th>
                {% if has_retour %}
                <th class="text-center">{{ total_quantite_retourner|floatformat:0 }}</th>
                {% endif %}
                <th class="text-center">-</th>
                <th class="text-end">{{ total_reduction|floatformat:0 }}</th>
                <th class="text-end">{{ total|floatformat:0 }}</th>
            </tr>
        </tfoot>
    </table>

    <!-- ====== TOTAL ====== -->
    <table>
        <tr>
            <td>
                <strong>LES PRODUITS SONT D’ORIGINE TURQUE</strong><br>
                <strong>LES PRODUITS SONT PRODUITS EN GUINÉE</strong>
            </td>
        </tr>
        <tr>
            <td class="total-box">TOTAL À PAYER : {{ total|floatformat:0 }} GNF</td>
        </tr>
    </table>

    <!-- ====== FOOTER ====== -->
    <div class="footer">
        <div class="footer-left">
            <img src="{% static 'img/logo_uba.jpg' %}" alt="UBA"><br>
            <strong>INTITULÉ :</strong> ITRACO BTP SARLU
            <strong>COMPTE :</strong> 60011030023275
            <strong>CLÉ RIB :</strong> 56
        </div>

        <div class="footer-right text-end">
            <strong>Le Responsable</strong><br>
            {{ entreprise.nom_entreprise }}<br>
            {{ today|date:"d/m/Y" }}
        </div>
    </div>

</div>
</body>
</html>
