{% extends 'admin.html' %}
{% load static %}
{% block contents %}

<style>
    .table-responsive { overflow-x: auto; width: 100%; }
    .table td, .table th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    .table img { max-width: 60px; max-height: 60px; object-fit: contain; }
    body { overflow-x: auto; }
</style>

        <div class="container-fluid">

        <!-- TITRE -->
        <h2 class="my-3">GESTION DE TOUTES LES VENTES</h2>

        <!-- MESSAGES -->
        {% for mgs in messages %}
        <div class="alert alert-{{ mgs.tags|default:'info' }}">{{ mgs }}</div>
        {% endfor %}

        <!-- ACTIONS -->
        <div class="row mb-3">
            <div class="col-md-6">
                <a href="{% url 'produits:choix_par_dates_ventes_impression' %}" class="btn btn-primary">
                    <i class="fa fa-print"></i> Imprimer la liste en PDF
                </a>
            </div>
            <div class="col-md-6 text-right">
                <a href="{% url 'produits:vendre_produit' %}" class="btn btn-danger">
                    <i class="fa fa-plus"></i> Nouvelle Vente
                </a>
            </div>
        </div>
<br>
        <!-- FILTRE PAR DATE -->
        <form method="get" class="row g-3 mb-4" action="{% url 'produits:filtrer_listes_ventes' %}">
            <div class="col-md-3">
                <label>Date D√©but</label>
                <input type="date" class="form-control" name="date_debut" value="{{ date_debut }}">
            </div>
            <div class="col-md-3">
                <label>Date Fin</label>
                <input type="date" class="form-control" name="date_fin" value="{{ date_fin }}">
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-primary me-2">üîç Filtrer</button>
                <a href="{% url 'produits:listes_des_ventes' %}" class="btn btn-secondary">Annuler</a>
            </div>
        </form>
<br>
        {% if listes_ventes or listes_ventes_filtre %}

        <!-- R√âSUM√â -->
        <div class="row mb-4 text-center">
            <div class="col-md-4"><div class="alert alert-info"><strong>Total Ventes</strong><br>{{ total_montant_ventes }} GNF</div></div>
            <div class="col-md-4"><div class="alert alert-success"><strong>B√©n√©fice Global</strong><br>{{ benefice_global }} GNF</div></div>
            <div class="col-md-4"><div class="alert alert-warning"><strong>Lignes de Vente</strong><br>{{ total_ventes }}</div></div>
        </div>

        <!-- TABLE DES VENTES -->
        <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
        <tr>
        <th>#</th><th>Ref Vente</th><th>Produit</th><th>Client</th>
        <th>Qt√©</th><th>Prix Vente</th><th>Sous-total</th><th>B√©n√©fice</th>
        <th>B√©n√©fice Total</th><th>Date</th><th>Photo</th><th>Imprimer</th><th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% with cumul_benefice=0 %}
        {% for elem in listes_ventes%}
        {% with cumul_benefice=cumul_benefice|add:elem.benefice %}
        <tr class="{% if elem.benefice < 0 %}table-danger{% endif %}">
        <td>{{ forloop.counter }}</td>
        <td>{{ elem.vente.code }}</td>
        <td>{{ elem.produit.desgprod }}</td>
        <td>{{ elem.vente.nom_complet_client }}</td>
        <td>{{ elem.quantite }}</td>
        <td>{{ elem.prix }} GNF</td>
        <td>{{ elem.sous_total }} GNF</td>
        <td>
        {% if elem.benefice >= 0 %}
        <span class="text-success"><b>+{{ elem.benefice }}</b></span>
        {% else %}
        <span class="text-danger"><b>{{ elem.benefice }}</b></span>
        {% endif %}
        </td>
        <td><span class="text-primary"><b>{{ cumul_benefice }}</b></span></td>
        <td>{{ elem.vente.date_vente|date:"Y-m-d" }}</td>
        <td>{% if elem.produit.photoprod %}<img src="{{ elem.produit.photoprod.url }}">{% else %}‚Äî{% endif %}</td>
        <td><a class="btn btn-primary btn-sm" href="{% url 'produits:recu_vente_global' elem.vente.code %}"><i class="fa fa-print"></i></a></td>
        <td>
                <button class="btn btn-danger btn-sm btn-produit-sup" data-id="{{ elem.id }}" data-toggle="modal" data-target="#supprimer">
                    <i class="fa fa-trash"></i>
                </button>
        </td>
        </tr>
        {% endwith %}{% endfor %}
        {% endwith %}
        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="4" class="text-center">Totaux :</th>
                                <th class="text-center">{{ total_vendus }}</th>
                                <th class="text-center">-</th>
                                <th class="text-center">{{ total_stocks }}</th>
                                <th class="text-center">-</th>
                                <th class="text-center">-</th>
                            </tr>
                        </tfoot>
        </table>

        </div>

        <h4 class="text-center mt-4">TOTAL DES VENTES PAR CAT√âGORIE</h4>
        <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th>#</th>
            <th>Cat√©gorie</th>
            <th>Quantit√© Vendue</th>
            <th>Montant Total (GNF)</th>
        </tr>
        </thead>
        <tbody>
        {% for cat in total_par_categorie %}
        <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ cat.produit__categorie__desgcategorie }}</td>
        <td>{{ cat.total_quantite }}</td>
        <td><strong>{{ cat.total_montant|floatformat:"0" }}</strong></td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-center text-muted">Aucune vente par cat√©gorie</td></tr>
        {% endfor %}
        </tbody>
                                      <tfoot class="table-secondary">
                            <tr>
                                <th colspan="2" class="text-center">Totaux :</th>
                                <th class="text-center">{{ total_vendus }}</th>
                                <th class="text-center">{{ total_stocks }}</th>
                                <th class="text-center">-</th>
                            </tr>
                        </tfoot>
        </table>

        {% else %}
        <p class="text-center text-muted">Aucune vente enregistr√©e.</p>
        {% endif %}

              <!-- ================= MODAL SUPPRESSION ================= -->
        <div class="modal fade" id="supprimer">
        <div class="modal-dialog">
        <div class="modal-content">
        <form method="POST" action="{% url 'produits:supprimer_ventes' %}">
        {% csrf_token %}
        <div class="modal-header bg-danger">
            <h4>SUPPRESSION</h4>
        </div>
        <div class="modal-body">
            <input type="hidden" name="id_supprimer" id="id_supprimer">
            Confirmer la suppression la ligne?
        </div>
            <div class="modal-footer">
            <button class="btn btn-default" data-dismiss="modal">Annuler</button>
            <button class="btn btn-danger">Supprimer</button>
             </div>
            </form>
           </div>
          </div>
         </div>

         </div>

        </div>

        <script>
        document.querySelectorAll('.btn-produit-sup').forEach(btn=>{
            btn.addEventListener('click', ()=>document.getElementById('id_supprimer').value = btn.dataset.id);
        });
        </script>

        {% endblock %}
