{% extends 'admin.html' %}
{% block contents %}

<h2>GESTION DES VENTES</h2>
<hr>

{% if messages %}
        <!-- MESSAGES -->
        {% for mgs in messages %}
        <div class="alert alert-{{ mgs.tags|default:'info' }}">{{ mgs }}</div>
        {% endfor %}
{% endif %}

<form method="post" id="form-vente">
  {% csrf_token %}

  <!-- ================= CLIENT ================= -->
  <div class="form-group mb-3">
    <label>Nom complet du client</label>
    <input type="text" class="form-control" name="nom_complet_client" required>
  </div>

  <div class="form-group mb-3">
    <label>T√©l√©phone du client</label>
    <input type="text"
           class="form-control"
           name="telephone_client"
           pattern="[0-9+ ]+"
           maxlength="15"
           required>
  </div>

  <div class="form-group mb-3">
    <label>Adresse du client</label>
    <input type="text" class="form-control" name="adresse_client" required>
  </div>

  <!-- ================= RECHERCHE ================= -->
  <div class="mb-3">
    <input id="search" class="form-control" placeholder="Rechercher produit (nom ou cat√©gorie)">
  </div>

  <!-- ================= TABLE PRODUITS ================= -->
  <table class="table table-bordered" id="table-produits">
    <thead class="table-dark">
      <tr>
        <th>Produit</th>
        <th>PU</th>
        <th>Stock</th>
        <th>Quantit√©</th>
        <th>R√©duction</th>
        <th>Sous-total</th>
      </tr>
    </thead>

    <tbody>
      {% for p in produits %}
      <tr class="produit-row">

        <td>
          <strong>{{ p.desgprod }}</strong><br>
          <small>{{ p.categorie.desgcategorie }}</small>
          <input type="hidden" name="produit_id[]" value="{{ p.id }}">
        </td>

        <td class="pu" data-pu="{{ p.pu }}">{{ p.pu }}</td>
        <td class="stock" data-stock="{{ p.stocks.qtestock|default:0 }}">{{ p.stocks.qtestock|default:0 }}</td>

        <!-- üîí QUANTIT√â -->
        <td>
          <input type="text"
                 name="quantite[]"
                 class="form-control qte only-numbers"
                 value="0"
                 inputmode="numeric"
                 autocomplete="off">
        </td>

        <!-- üîí R√âDUCTION -->
        <td>
          <input type="text"
                 name="reduction[]"
                 class="form-control reduction only-numbers"
                 value="0"
                 inputmode="numeric"
                 autocomplete="off">
        </td>

        <td class="sous-total">0</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center">Aucun produit disponible.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ================= TOTAL ================= -->
  <div class="text-end mt-3">
    <h4>Total Global : <span id="total-general">0</span> GNF</h4>
  </div>

  <button class="btn btn-success mt-3" id="btn-valider" disabled>
    Valider la vente
  </button>
</form>

<!-- ================= SCRIPTS ================= -->

<script>
/* üîí Bloquer lettres & caract√®res sp√©ciaux */
document.addEventListener("input", function (e) {
  if (e.target.classList.contains("only-numbers")) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  }
});

/* üîÑ Recalcul */
function recalc() {
  let total = 0;

  document.querySelectorAll(".produit-row").forEach(row => {
    const qteInput = row.querySelector(".qte");
    const reductionInput = row.querySelector(".reduction");

    let qte = parseInt(qteInput.value || "0", 10);
    let reduction = parseInt(reductionInput.value || "0", 10);

    if (isNaN(qte)) qte = 0;
    if (isNaN(reduction)) reduction = 0;

    const pu = parseInt(row.querySelector(".pu").dataset.pu, 10);
    const stock = parseInt(row.querySelector(".stock").dataset.stock, 10);

    // üîí S√©curit√© stock
    if (qte > stock) {
      qte = stock;
      qteInput.value = stock;
    }

    // üîí S√©curit√© r√©duction
    if (reduction > pu) {
      reduction = pu;
      reductionInput.value = pu;
    }

    const sousTotal = qte * (pu - reduction);
    row.querySelector(".sous-total").textContent = sousTotal.toLocaleString();
    total += sousTotal;
  });

  document.getElementById("total-general").textContent = total.toLocaleString();
  document.getElementById("btn-valider").disabled = total <= 0;
}

document.querySelectorAll(".qte, .reduction").forEach(i => {
  i.addEventListener("input", recalc);
});

/* üîç Recherche produit */
document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  document.querySelectorAll(".produit-row").forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

recalc();
</script>

{% endblock %}
