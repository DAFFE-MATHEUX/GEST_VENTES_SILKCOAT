{% extends 'admin.html' %}
{% block contents %}

<style>
    .table-responsive { overflow-x: auto; width: 100%; }
    .table td, .table th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    .table img { max-width: 60px; max-height: 60px; object-fit: contain; }
    body { overflow-x: auto; }

    /* Style pour les totaux du modal */
    .modal-totals td {
        font-weight: bold;
        background-color: #f2f2f2;
    }
</style>

<h2>GESTION DES VENTES</h2>
<hr>

<!-- ================= MESSAGES ================= -->
{% if messages %}
  {% for mgs in messages %}
    <div class="alert alert-{{ mgs.tags|default:'info' }}">
      {{ mgs }}
    </div>
  {% endfor %}
{% endif %}

<form method="post" id="form-vente">
{% csrf_token %}

<!-- ================= CLIENT ================= -->
<div class="card mb-3">
  <div class="card-header bg-light"><strong>Informations du client</strong></div>
  <div class="card-body">
    <div class="form-group mb-2">
      <label>Nom complet</label>
      <input type="text" class="form-control" id="client_nom"
             name="nom_complet_client" required>
    </div>

    <div class="form-group mb-2">
      <label>T√©l√©phone</label>
      <input type="text" class="form-control" id="client_tel"
             name="telephone_client" required>
    </div>

    <div class="form-group mb-2">
      <label>Adresse</label>
      <input type="text" class="form-control" id="client_adresse"
             name="adresse_client" required>
    </div>
  </div>
</div>

<!-- ================= RECHERCHE ================= -->
<input id="search" class="form-control mb-3"
       placeholder="Rechercher produit ou cat√©gorie">

<!-- ================= TABLE PRODUITS ================= -->
<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover">
    <thead class="thead-dark">
      <tr>
        <th>#</th>
        <th>Produit</th>
        <th>Prix Unitaire</th>
        <th>Stock Dispo</th>
        <th>Quantit√© √† ach√©ter</th>
        <th>R√©duction / prod</th>
        <th>Sous-total par Produit</th>
      </tr>
    </thead>
    <tbody>
      {% for p in produits %}
      <tr class="produit-row">
        <td>{{ forloop.counter }}</td>
        <td>
          <strong>{{ p.desgprod }}</strong><br>
          <small>{{ p.categorie.desgcategorie }}</small>
          <input type="hidden" name="produit_id[]" value="{{ p.id }}">
        </td>

        <td class="pu" data-pu="{{ p.pu }}">{{ p.pu }}</td>
        <td class="stock" data-stock="{{ p.stocks.qtestock|default:0 }}">
          {{ p.stocks.qtestock|default:0 }}
        </td>

        <td>
          <input type="text" name="quantite[]"
                 class="form-control qte only-numbers" value="0">
        </td>

        <td>
          <input type="text" name="reduction[]"
                 class="form-control reduction only-numbers" value="0">
        </td>

        <td class="sous-total">0</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3" class="text-center"><strong>Totaux</strong></td>
        <td id="tfoot-stock"></td>
        <td id="tfoot-quantite"></td>
        <td id="tfoot-reduction"></td>
        <td id="tfoot-net"></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- ================= TOTAL ================= -->
<div class="text-right mt-3">
  <h4>Total brut : <span id="total-brut">0</span></h4>
  <h4 class="text-danger">R√©duction totale : <span id="total-reduction">0</span></h4>
  <h3>Total net √† payer : <strong id="total-net">0</strong></h3>
  <h5>Total quantit√© : <span id="total-quantite">0</span></h5>
</div>

<!-- Bouton validation -->
<button type="button"
        id="btn-valider"
        class="btn btn-success mt-3"
        data-toggle="modal"
        data-target="#modalConfirmation"
        disabled>
  Valider la vente
</button>

<!-- ================= MODAL ================= -->
<div class="modal fade" id="modalConfirmation">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- HEADER -->
      <div class="modal-header bg-success text-white">
        <h4>R√©capitulatif de la vente</h4>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <!-- CLIENT -->
        <div class="card mb-3">
          <div class="card-header"><strong>Informations du Client</strong></div>
          <div class="card-body">
            <p><strong>Nom :</strong> <span id="recap-client-nom"></span></p>
            <p><strong>T√©l√©phone :</strong> <span id="recap-client-tel"></span></p>
            <p><strong>Adresse :</strong> <span id="recap-client-adresse"></span></p>
          </div>
        </div>

        <!-- PRODUITS -->
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="thead-dark">
              <tr>
                <th>#</th>
                <th>Produit</th>
                <th>PU</th>
                <th>Qt√©</th>
                <th>Sous-total</th>
                <th>R√©duction appliqu√©e</th>
              </tr>
            </thead>
            <tbody id="recap-body"></tbody>
            <!-- ================= FOOTER AVEC TOTAUX ================= -->
            <tfoot class="modal-totals">
              <tr>
                <td colspan="2" class="text-center"><strong>Totaux</strong></td>
                <td id="modal-total-brut">0 GNF</td>
                <td id="modal-total-quantite">0</td>
                <td id="modal-total-net">0 GNF</td>
                <td id="modal-total-reduction">0 GNF</td>
              </tr>
            </tfoot>
          </table>
        </div>

      </div>

      <!-- FOOTER -->
      <div class="modal-footer">
        <button class="btn btn-default" data-dismiss="modal">Modifier les ventes</button>
        <button type="submit" class="btn btn-success">Confirmer la vente</button>
      </div>

    </div>
  </div>
</div>

</form>


<script>

  // üö´ Bloquer la touche Entr√©e dans tout le formulaire
document.getElementById("form-vente").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
        e.preventDefault();
        return false;
    }
});

// Autoriser uniquement les chiffres
document.addEventListener("input", e => {
  if (e.target.classList.contains("only-numbers")) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  }
});

const totalBrutEl = document.getElementById('total-brut');
const totalReductionEl = document.getElementById('total-reduction');
const totalNetEl = document.getElementById('total-net');
const totalQuantiteEl = document.getElementById('total-quantite');

const tfootNet = document.getElementById('tfoot-net');
const tfootQuantite = document.getElementById('tfoot-quantite');
const tfootReduction = document.getElementById('tfoot-reduction');

const btnValider = document.getElementById('btn-valider');

const clientNomInput = document.getElementById('client_nom');
const clientTelInput = document.getElementById('client_tel');
const clientAdresseInput = document.getElementById('client_adresse');

const recapClientNom = document.getElementById('recap-client-nom');
const recapClientTel = document.getElementById('recap-client-tel');
const recapClientAdresse = document.getElementById('recap-client-adresse');

const recapBody = document.getElementById('recap-body');
const modalTotalBrutEl = document.getElementById('modal-total-brut');
const modalTotalReductionEl = document.getElementById('modal-total-reduction');
const modalTotalNetEl = document.getElementById('modal-total-net');
const modalTotalQuantiteEl = document.getElementById('modal-total-quantite');

function recalc() {
  let totalBrut = 0, totalReduction = 0, totalQuantite = 0, totalNet = 0;

  document.querySelectorAll(".produit-row").forEach(row => {
    let qte = parseInt(row.querySelector(".qte").value) || 0;
    let reduction = parseInt(row.querySelector(".reduction").value) || 0;

    const pu = parseInt(row.querySelector(".pu").dataset.pu) || 0;
    const stock = parseInt(row.querySelector(".stock").dataset.stock) || 0;

    if(qte > stock) { qte = stock; row.querySelector(".qte").value = stock; }
    if(reduction > pu) { reduction = pu; row.querySelector(".reduction").value = pu; }

    const prixNetUnitaire = pu - reduction;
    const sousTotal = qte * prixNetUnitaire;

    row.querySelector(".sous-total").textContent = sousTotal.toLocaleString() + " GNF";

    totalBrut += qte * pu;
    totalReduction +=  reduction;
    totalQuantite += qte;
    totalNet += sousTotal;
  });

  totalBrutEl.textContent = totalBrut.toLocaleString() + " GNF";
  totalReductionEl.textContent = totalReduction.toLocaleString() + " GNF";
  totalNetEl.textContent = totalNet.toLocaleString() + " GNF";
  totalQuantiteEl.textContent = totalQuantite;

  tfootNet.textContent = totalNet.toLocaleString() + " GNF";
  tfootReduction.textContent = totalReduction.toLocaleString() + " GNF";
  tfootQuantite.textContent = totalQuantite.toLocaleString();

  btnValider.disabled = totalNet <= 0;
}

document.querySelectorAll(".qte, .reduction").forEach(el => el.addEventListener("input", recalc));

document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  document.querySelectorAll(".produit-row").forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

btnValider.addEventListener("click", function() {
  recapClientNom.textContent = clientNomInput.value;
  recapClientTel.textContent = clientTelInput.value;
  recapClientAdresse.textContent = clientAdresseInput.value;

  recapBody.innerHTML = "";
  let totalBrut = 0, totalReduction = 0, totalQuantite = 0, totalNet = 0;
  let compteur = 1;

  document.querySelectorAll(".produit-row").forEach(row => {
    const qte = parseInt(row.querySelector(".qte").value) || 0;
    if(qte <= 0) return;

    const produit = row.querySelector("strong").textContent;
    const pu = parseInt(row.querySelector(".pu").dataset.pu) || 0;
    const reduction = parseInt(row.querySelector(".reduction").value) || 0;

    const prixNetUnitaire = pu - reduction;
    const sousTotal = qte * prixNetUnitaire;

    recapBody.innerHTML += `
      <tr>
        <td>${compteur++}</td>
        <td>${produit}</td>
        <td>${pu.toLocaleString()} GNF</td>
        <td>${qte}</td>
        <td>${sousTotal.toLocaleString()} GNF</td>
        <td>${(reduction).toLocaleString()} GNF</td>
      </tr>
    `;

    totalBrut += qte * pu;
    totalReduction += reduction;
    totalQuantite += qte;
    totalNet += sousTotal;
  });

  // Totaux dans le footer du modal
  modalTotalBrutEl.textContent = totalBrut.toLocaleString() + " GNF";
  modalTotalReductionEl.textContent = totalReduction.toLocaleString() + " GNF";
  modalTotalNetEl.textContent = totalNet.toLocaleString() + " GNF";
  modalTotalQuantiteEl.textContent = totalQuantite.toLocaleString();
});

recalc();

                // Faire dispara√Ætre les messages apr√®s 4 secondes
            setTimeout(function() {
                let messages = document.querySelectorAll('.sucess');
                messages.forEach(function(el) {
                    el.style.transition = "opacity 0.5s";
                    el.style.opacity = "0";
                    setTimeout(() => el.remove(), 500);
                });
            }, 6000);

</script>

{% endblock %}
