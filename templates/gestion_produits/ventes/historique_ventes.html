{% extends 'admin.html' %}
{% block contents %}

<style>
@media print {
    body * {
        visibility: hidden;
    }
    .print-area, .print-area * {
        visibility: visible;
    }
    .print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .no-print {
        display: none !important;
    }
}
</style>

<!-- Bouton impression -->
<div class="no-print mb-3 text-end">
    <button onclick="window.print()" class="btn btn-success">
        üñ®Ô∏è Imprimer
    </button>
</div>

<!-- Recherche -->
<div class="row mb-3 no-print">
    <div class="col-md-6 col-sm-12 mt-2">
        <div class="input-group" style="max-width: 400px;">
            <input
                type="text"
                class="form-control"
                placeholder="üîé Rechercher (client, code, produit, vendeur...)"
                id="rechercher_informations"
            >
        </div>
    </div>
</div>

<div class="print-area">

<h2 class="mt-3 text-center">üìä HISTORIQUE DES VENTES</h2>
<hr>

{% if historique %}
    {% for bloc in historique %}

    <!-- BLOC JOUR -->
    <div class="card mb-4 shadow vente-bloc">

        <!-- EN-T√äTE -->
        <div class="card-header bg-dark text-white">
            <h4>üìÖ {{ bloc.date|date:"d/m/Y" }}</h4>
            <small>
                üí∞ Total ventes :
                <strong>{{ bloc.total_montant|floatformat:"0" }} GNF</strong> |
                üì¶ Qt√© vendue :
                <strong>{{ bloc.total_quantite }}</strong> |
                üìà B√©n√©fice :
                <strong>{{ bloc.total_profit|floatformat:"0" }} GNF</strong>
            </small>
        </div>

        <!-- TABLE -->
        <div class="card-body table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Code</th>
                        <th>Client</th>
                        <th>Total</th>
                        <th>B√©n√©fice</th>
                        <th>Vendeur</th>
                        <th>Date</th>
                        <th>Heure</th>
                    </tr>
                </thead>

                <tbody class="table-vente">
                {% for v in bloc.ventes %}
                    <!-- VENTE -->
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><strong>{{ v.code }}</strong></td>
                        <td>
                            {{ v.nom_complet_client }}<br>
                            <small>{{ v.telclt_client }}</small>
                        </td>
                        <td>{{ v.total|floatformat:"0" }} GNF</td>
                        <td>{{ v.benefice_total|floatformat:"0" }} GNF</td>
                        <td>{{ v.utilisateur.get_full_name }}</td>
                        <td>{{ v.date_vente|date:'d/m/Y' }}</td>
                        <td>{{ v.date_vente }}</td>
                    </tr>

                    <!-- D√âTAILS PRODUITS -->
                    <tr>
                        <td colspan="8">
                            <strong>D√©tails des produits :</strong>
                            <table class="table table-sm table-bordered mt-2">
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Qt√© vendue</th>
                                        <th>Qt√© retourn√©e</th>
                                        <th>Qt√© restante</th>
                                        <th>PU</th>
                                        <th>Sous-total</th>
                                        <th>B√©n√©fice</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for ligne in v.lignes.all %}
                                    <tr>
                                        <td>
                                            {{ ligne.produit.desgprod }}<br>
                                            <small class="text-muted">
                                                {{ ligne.produit.categorie.desgcategorie }}
                                            </small>
                                        </td>
                                        <td class="text-center">{{ ligne.quantite }}</td>
                                        <td class="text-center">{{ ligne.quantite_retournee }}</td>
                                        <td class="text-center">{{ ligne.quantite_restante }}</td>
                                        <td class="text-end">{{ ligne.prix|floatformat:"0" }}</td>
                                        <td class="text-end">{{ ligne.sous_total|floatformat:"0" }}</td>
                                        <td class="text-end">{{ ligne.benefice|floatformat:"0" }}</td>
                                    </tr>

                                    {% if ligne.retours.exists %}
                                    <tr>
                                        <td colspan="7">
                                            <small class="text-danger">
                                                üîÅ Retours :
                                                {% for ret in ligne.retours.all %}
                                                    {{ ret.quantite_retour }}
                                                    {% if ret.motif %} ({{ ret.motif }}){% endif %}
                                                    {% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endfor %}
{% else %}
    <p class="text-center text-muted">Aucune vente enregistr√©e.</p>
{% endif %}

</div>

<!-- SCRIPT RECHERCHE -->
<script>
document.getElementById("rechercher_informations").addEventListener("keyup", function () {
    let value = this.value.toLowerCase();

    document.querySelectorAll(".vente-bloc").forEach(bloc => {
        let lignes = bloc.querySelectorAll(".table-vente tr");
        let trouve = false;

        lignes.forEach(row => {
            if (row.textContent.toLowerCase().includes(value)) {
                row.style.display = "";
                trouve = true;
            } else {
                row.style.display = "none";
            }
        });

        bloc.style.display = trouve ? "" : "none";
    });
});
</script>

{% endblock %}
