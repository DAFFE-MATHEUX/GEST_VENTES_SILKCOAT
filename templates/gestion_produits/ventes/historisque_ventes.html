{% extends 'admin.html' %}
{% block contents %}

<h2 class="mt-3">üìÑ HISTORIQUES DES VENTES</h2>
<hr>

{% if messages %}
    {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
    {% endfor %}
{% endif %}

<!-- üîç BARRE DE RECHERCHE + FILTRE DATE -->
<div class="row mb-3">

    <div class="col-md-4">
        <input id="search" class="form-control" placeholder="Rechercher (client, produit, vendeur, code...)">
    </div>

    <div class="col-md-3">
        <input type="date" id="filter-date" class="form-control">
    </div>
</div>
<br>
<!-- TABLEAU DES VENTES -->
<table class="table table-bordered table-striped table-hover" id="table-ventes">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Code Vente</th>
            <th>Client</th>
            <th>Montant Total (GNF)</th>
            <th>Vendu par</th>
            <th>Date</th>
            <th>Statut</th>
            <th>Re√ßu</th>
            <th>Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for v in ventes %}
        <tr class="vente-row">

            <td>{{ forloop.counter }}</td>

            <td><strong>{{ v.code }}</strong></td>

            <td>
                {{ v.client_nom|default:"Non renseign√©" }}<br>
                <small>{{ v.client_telephone|default:"-" }}</small>
            </td>

            <td><strong>{{ v.total|floatformat:"0" }}</strong></td>

            <td>{{ v.utilisateur }}</td>

            <td>{{ v.date_vente|date:"d/m/Y H:i" }}</td>

            <td>
                {% if v.paye %}
                    <span class="badge bg-success">Pay√©</span>
                {% else %}
                    <span class="badge bg-danger">Non Pay√©</span>
                {% endif %}
            </td>

            <td>
                <a href="{% url 'produits:recu_vente_global' v.code %}"
                   target="_blank"
                   class="btn btn-primary btn-sm">
                    <i class="fa fa-file"></i> Voir
                </a>
            </td>

            <td>
                <a href=""
                   class="btn btn-danger btn-sm"
                   onclick="return confirm('Supprimer cette vente ?');">
                    <i class="fa fa-trash"></i>
                </a>
            </td>

        </tr>
        {% empty %}
        <tr>
            <td colspan="9" class="text-center">Aucune vente enregistr√©e.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- TOTAL DU JOUR -->
<div class="text-right mt-3">
    <h4>Total des ventes : <span id="total-affiche">{{ total_general|floatformat:"0" }}</span> GNF</h4>
</div>


<!-- üî• SCRIPTS JS -->
<script>
    // Recherche instantan√©e
    document.getElementById("search").addEventListener("input", function () {
        const q = this.value.toLowerCase();

        document.querySelectorAll(".vente-row").forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(q) ? "" : "none";
        });
    });

    // Filtrer par date
    document.getElementById("filter-date").addEventListener("change", function () {
        const dateFiltre = this.value;

        document.querySelectorAll(".vente-row").forEach(row => {
            const dateRow = row.children[5].textContent.trim(); // colonne date

            if (dateFiltre === "") {
                row.style.display = "";
            } else {
                row.style.display = dateRow.startsWith(dateFiltre.split("-").reverse().join("/"));
            }
        });
    });
</script>

{% endblock %}
