{% extends 'admin.html' %}
{% load static %}
{% block contents %}

<style>
    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }
    .table td, .table th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }
    .table img {
        max-width: 60px;
        max-height: 60px;
        object-fit: contain;
    }
</style>

<div id="page-wrapper">
<div id="page-inner">

<!-- ================= TITRE ================= -->
<div class="row">
    <div class="col-md-12">
        <h2>GESTION DE TOUS LES PRODUITS</h2>
    </div>
</div>
<br>

<!-- ================= MESSAGES ================= -->
{% if messages %}
{% for mgs in messages %}
<div class="alert 
    {% if mgs.tags == 'success' %} alert-success
    {% elif mgs.tags == 'error' %} alert-danger
    {% else %} alert-info {% endif %}">
    {{ mgs }}
</div>
{% endfor %}
{% endif %}

<!-- ================= ACTIONS ================= -->
<div class="row mb-3">
    <div class="col-md-6">
        <a href="{% url 'produits:listes_produits_impression' %}" class="btn btn-primary">
            <i class="fa fa-print"></i> Imprimer la liste en PDF
        </a>
    </div>

    <div class="col-md-6 text-right">
        <a href="{% url 'produits:nouveau_produit' %}" class="btn btn-danger">
            <i class="fa fa-plus"></i> NOUVEAU PRODUIT
        </a>
    </div>
</div>
<br>
<!-- ================= PANEL ================= -->
<div class="panel panel-default">
<div class="panel-heading">LISTE DES PRODUITS ENREGISTRÉS</div>
<div class="panel-body">

<!-- ================= RÉSUMÉ ================= -->
<div class="row mb-3">
    <div class="col-md-6">
        <strong style="font-size:18px;">
            Total Produits : {{ total_produit }}
        </strong>
    </div>

    <div class="col-md-6 text-right">
        <input type="text" class="form-control"
               placeholder="Rechercher un produit..."
               id="rechercher_informations"
               style="max-width:300px; float:right;">
    </div>
</div>

<!-- ================= TABLE PRODUITS ================= -->
<div class="table-responsive">
<table class="table table-striped table-bordered table-hover">
<thead>
<tr>
    <th>#</th>
    <th>Réf</th>
    <th>Catégorie</th>
    <th>Désignation</th>
    <th>PU</th>
    {% if not request.user.type_utilisateur == 'Gerante' %}
    <th>PU Gros</th>
    {% endif %}
    <th>Date</th>
    <th>Photo</th>
    <th>Actions</th>
</tr>
</thead>

<tbody id="my_table">
{% for elem in listes_produits %}
<tr>
    <td>{{ forloop.counter }}</td>
    <td>{{ elem.refprod }}</td>
    <td>{{ elem.categorie }}</td>
    <td>{{ elem.desgprod }}</td>
    <td>{{ elem.pu|floatformat:0 }}</td>
    {% if not request.user.type_utilisateur == 'Gerante' %}
    <td>{{ elem.prix_en_gros|floatformat:0 }}</td>
    {% endif %}
    <td>{{ elem.date_maj|date:"d/m/Y" }}</td>
    <td>
        {% if elem.photoprod %}
            <img src="{{ elem.photoprod.url }}">
        {% else %}
            —
        {% endif %}
    </td>
    <td>
        <a class="btn btn-primary btn-sm" href="{% url 'produits:consulter_produit' elem.id %}">
            <i class="fa fa-eye"></i>
        </a>
        <a class="btn btn-info btn-sm" href="{% url 'produits:editer_produit' elem.id %}">
            <i class="fa fa-edit"></i>
        </a>
        <button class="btn btn-danger btn-sm btn-produit-sup"
                data-id="{{ elem.id }}"
                data-toggle="modal"
                data-target="#supprimer">
            <i class="fa fa-trash"></i>
        </button>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="9" class="text-center">Aucun produit enregistré</td>
</tr>
{% endfor %}
</tbody>
</table>

<!-- ================= TOTAL PAR CATÉGORIE ================= -->
<h4>Total des produits par catégorie</h4>

<table class="table table-bordered table-striped">
<thead>
<tr>
    <th>Catégorie</th>
    <th>Nombre de produits</th>
    <th>Quantité stock</th>
    <th>Valeur stock</th>
</tr>
</thead>
<tbody>
{% for cat in total_par_categorie %}
<tr>
    <td>{{ cat.categorie__desgcategorie }}</td>
    <td>{{ cat.nombre_produits }}</td>
    <td>{{ cat.quantite_stock|default:0 }}</td>
    <td>{{ cat.valeur_stock|default:0|floatformat:0 }} GNF</td>
</tr>
{% empty %}
<tr>
    <td colspan="4" class="text-center">Aucune donnée</td>
</tr>
{% endfor %}
</tbody>
</table>

<!-- ================= PAGINATION ================= -->
<nav>
<ul class="pagination justify-content-center">
    {% if listes_produits.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?pages=1">&laquo;</a>
    </li>
    <li class="page-item">
        <a class="page-link" href="?pages={{ listes_produits.previous_page_number }}">Préc</a>
    </li>
    {% endif %}

    <li class="page-item active">
        <span class="page-link">
            {{ listes_produits.number }} / {{ listes_produits.paginator.num_pages }}
        </span>
    </li>

    {% if listes_produits.has_next %}
    <li class="page-item">
        <a class="page-link" href="?pages={{ listes_produits.next_page_number }}">Suiv</a>
    </li>
    <li class="page-item">
        <a class="page-link" href="?pages={{ listes_produits.paginator.num_pages }}">&raquo;</a>
    </li>
    {% endif %}
</ul>
</nav>

</div>
</div>
</div>

<!-- ================= MODAL SUPPRESSION ================= -->
<div class="modal fade" id="supprimer">
<div class="modal-dialog">
<div class="modal-content">
<form method="POST" action="{% url 'produits:supprimer_produits' %}">
{% csrf_token %}
<div class="modal-header bg-danger">
    <h4>SUPPRESSION</h4>
</div>
<div class="modal-body">
    <input type="hidden" name="id_supprimer" id="id_supprimer">
    Confirmer la suppression ?
</div>
<div class="modal-footer">
    <button class="btn btn-default" data-dismiss="modal">Annuler</button>
    <button class="btn btn-danger">Supprimer</button>
</div>
</form>
</div>
</div>
</div>

</div>
</div>

<!-- ================= SCRIPTS ================= -->
<script>
document.querySelectorAll('.btn-produit-sup').forEach(btn=>{
    btn.onclick = ()=> document.getElementById('id_supprimer').value = btn.dataset.id;
});

document.getElementById("rechercher_informations").addEventListener("keyup", function () {
    let value = this.value.toLowerCase();
    document.querySelectorAll("#my_table tr").forEach(row=>{
        row.style.display = row.textContent.toLowerCase().includes(value) ? "" : "none";
    });
});

setTimeout(()=>{
    document.querySelectorAll('.alert').forEach(a=>a.remove());
}, 4000);
</script>

{% endblock %}
