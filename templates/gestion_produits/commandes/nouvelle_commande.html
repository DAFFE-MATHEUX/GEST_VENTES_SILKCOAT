{% extends 'admin.html' %}
{% block contents %}

<style>
    .table-responsive { overflow-x: auto; width: 100%; }
    .table td, .table th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    .table img { max-width: 60px; max-height: 60px; object-fit: contain; }
    body { overflow-x: auto; }
</style>

<h2>GESTION DES COMMANDES</h2>
<hr>

{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }}">{{ m }}</div>
  {% endfor %}
{% endif %}

<form method="post" id="form-commande">
  {% csrf_token %}

  <!-- ================= FOURNISSEUR ================= -->
  <div class="form-group mb-3">
    <label>Nom complet du Fournisseur</label>
    <input type="text" class="form-control" id="nom_fournisseur"
           name="nom_complet_fournisseur" required>
  </div>

  <div class="form-group mb-3">
    <label>Téléphone</label>
    <input type="text" class="form-control" id="tel_fournisseur"
           name="telephone_fournisseur" required>
  </div>

  <div class="form-group mb-3">
    <label>Adresse</label>
    <input type="text" class="form-control" id="adresse_fournisseur"
           name="adresse_fournisseur" required>
  </div>

  <!-- ================= RECHERCHE ================= -->
  <div class="mb-3">
    <input id="search" class="form-control"
           placeholder="Rechercher produit ou catégorie">
  </div>

  <!-- ================= TABLE PRODUITS ================= -->
   <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Catégorie</th>
        <th>Produit</th>
        <th>Stock Dispo</th>
        <th>Quantité à commander</th>
      </tr>
    </thead>

    <tbody>
      {% for p in produits_data %}
      <tr class="produit-row">
        <td>{{ forloop.counter }}</td>
        <td>{{ p.produit.categorie.desgcategorie }}</td>
        <td>{{ p.produit.desgprod }}</td>
        <td>{{ p.produit.stocks.qtestock }}</td>
        <td>
          <input type="text"
                 class="form-control qte only-numbers"
                 name="quantite[]" value="0">
          <input type="hidden"
                 name="produit_id[]"
                 value="{{ p.produit.id }}">
        </td>
      </tr>
      {% endfor %}
    </tbody>

    <tfoot>
      <tr class="table-light">
        <td colspan="3" class="text-end fw-bold">
          TOTAL COMMANDE
        </td>
        <td>{{ stock_total }}</td>
        <td>
          <input type="text"
                 class="form-control total_commande"
                 name="total_commande"
                 value="0"
                 readonly>
        </td>
        
      </tr>
    </tfoot>
  </table>

   </div>


  <!-- ================= BOUTON ================= -->
  <button type="button"
          class="btn btn-success mt-3"
          id="btn-valider"
          data-toggle="modal"
          data-target="#modalCommande"
          disabled>
    Valider la commande
  </button>

  <!-- ================= MODAL ================= -->
  <div class="modal fade" id="modalCommande">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header bg-success text-white">
          <h4>Confirmation de la commande</h4>
        </div>

        <div class="modal-body">

          <!-- FOURNISSEUR -->
          <div class="card mb-3">
            <div class="card-header"><strong>Fournisseur</strong></div>
            <div class="card-body">
              <p><b>Nom :</b> <span id="recap-nom"></span></p>
              <p><b>Téléphone :</b> <span id="recap-tel"></span></p>
              <p><b>Adresse :</b> <span id="recap-adresse"></span></p>
            </div>
          </div>

          <!-- PRODUITS -->
           <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Catégorie</th>
                <th>Produit</th>
                <th>Quantité</th>
              </tr>
            </thead>
            <tbody id="recap-body"></tbody>
          </table>

           </div>


          <h5 class="text-end">
            Total Quantité :
            <strong><span id="total-qte">0</span></strong>
          </h5>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-dismiss="modal">
            Modifier
          </button>
          <button type="submit" class="btn btn-success">
            Confirmer la commande
          </button>
        </div>

      </div>
    </div>
  </div>
</form>

<!-- ================= JAVASCRIPT ================= -->
<script>
/* Autoriser uniquement les chiffres */
document.addEventListener("input", e => {
  if (e.target.classList.contains("only-numbers")) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  }
});

/* Calcul total commande */
function calculerTotal() {
  let total = 0;

  document.querySelectorAll(".qte").forEach(input => {
    total += parseInt(input.value || 0);
  });

  document.querySelector(".total_commande").value = total;
  document.getElementById("total-qte").textContent = total;

  document.getElementById("btn-valider").disabled = total === 0;
}

/* Recherche */
document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  document.querySelectorAll(".produit-row").forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

/* Remplir modal */
document.getElementById("btn-valider").addEventListener("click", function () {

  document.getElementById("recap-nom").textContent =
    document.getElementById("nom_fournisseur").value;
  document.getElementById("recap-tel").textContent =
    document.getElementById("tel_fournisseur").value;
  document.getElementById("recap-adresse").textContent =
    document.getElementById("adresse_fournisseur").value;

  const recap = document.getElementById("recap-body");
  recap.innerHTML = "";
  let i = 1;

  document.querySelectorAll(".produit-row").forEach(row => {
    const qte = parseInt(row.querySelector(".qte").value || 0);
    if (qte > 0) {
      recap.innerHTML += `
        <tr>
          <td>${i++}</td>
          <td>${row.children[1].textContent}</td>
          <td>${row.children[2].textContent}</td>
          <td>${qte}</td>
        </tr>`;
    }
  });
});

/* Écouteurs */
document.querySelectorAll(".qte")
  .forEach(input => input.addEventListener("input", calculerTotal));

calculerTotal();
</script>

{% endblock %}
