{% extends 'admin.html' %}
{% block contents %}

<h2>GESTION DES COMMANDES</h2>
<hr>

{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }}">
      {{ m }}
    </div>
  {% endfor %}
{% endif %}

<form method="post" id="form-commande">
  {% csrf_token %}

  <!-- ================= FOURNISSEUR ================= -->
  <div class="form-group mb-3">
    <label>Nom complet du Fournisseur</label>
    <input type="text"
           class="form-control"
           id="nom_fournisseur"
           name="nom_complet_fournisseur"
           required>
  </div>

  <div class="form-group mb-3">
    <label>Téléphone</label>
    <input type="text"
           class="form-control"
           id="tel_fournisseur"
           name="telephone_fournisseur"
           pattern="[0-9+ ]+"
           maxlength="15"
           required>
  </div>

  <div class="form-group mb-3">
    <label>Adresse</label>
    <input type="text"
           class="form-control"
           id="adresse_fournisseur"
           name="adresse_fournisseur"
           required>
  </div>

  <!-- ================= RECHERCHE ================= -->
  <div class="mb-3">
    <input id="search" class="form-control"
           placeholder="Rechercher produit ou catégorie">
  </div>

  <!-- ================= TABLE PRODUITS ================= -->
  <table class="table table-bordered">
    <thead class="thead-dark">
      <tr>
        <th>Catégorie</th>
        <th>Produit</th>
        <th>Quantité à commander</th>
      </tr>
    </thead>

    <tbody>
      {% for p in produits_data %}
      <tr class="produit-row">
        <td>{{ p.produit.categorie.desgcategorie }}</td>
        <td>{{ p.produit.desgprod }}</td>
        <td>
          <input type="text"
                 name="quantite[]"
                 class="form-control qte only-numbers"
                 value="0">
          <input type="hidden"
                 name="produit_id[]"
                 value="{{ p.produit.id }}">
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3" class="text-center">
          Aucun produit disponible
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ================= BOUTON MODAL ================= -->
  <button type="button"
          class="btn btn-success mt-3"
          id="btn-valider"
          data-toggle="modal"
          data-target="#modalCommande"
          disabled>
    Valider la commande
  </button>

  <!-- ==================================================
       MODAL CONFIRMATION COMMANDE
  ================================================== -->
  <div class="modal fade" id="modalCommande">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header bg-success text-white">
          <h4>Confirmation de la commande</h4>
        </div>

        <div class="modal-body">

          <!-- ===== INFOS FOURNISSEUR ===== -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong>Informations du fournisseur</strong>
            </div>
            <div class="card-body">
              <p><strong>Nom :</strong> <span id="recap-nom"></span></p>
              <p><strong>Téléphone :</strong> <span id="recap-tel"></span></p>
              <p><strong>Adresse :</strong> <span id="recap-adresse"></span></p>
            </div>
          </div>

          <!-- ===== PRODUITS ===== -->
          <table class="table table-bordered">
            <thead class="thead-dark">
              <tr>
                <th>Catégorie</th>
                <th>Produit</th>
                <th>Quantité</th>
              </tr>
            </thead>
            <tbody id="recap-body"></tbody>
          </table>

          <h5 class="text-right">
            Total Quantité :
            <strong><span id="total-qte">0</span></strong>
          </h5>

        </div>

        <div class="modal-footer">
          <button class="btn btn-default" data-dismiss="modal">
            Modifier
          </button>
          <button type="submit" class="btn btn-success">
            Confirmer la commande
          </button>
        </div>

      </div>
    </div>
  </div>

</form>

<!-- ================= JAVASCRIPT ================= -->
<script>
/* Chiffres uniquement */
document.addEventListener("input", function (e) {
  if (e.target.classList.contains("only-numbers")) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  }
});

/* Activer bouton */
function verifierCommande() {
  let actif = false;
  document.querySelectorAll(".qte").forEach(input => {
    if (parseInt(input.value || 0) > 0) actif = true;
  });
  document.getElementById("btn-valider").disabled = !actif;
}

/* Recherche */
document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  document.querySelectorAll(".produit-row").forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

/* Remplir modal */
document.getElementById("btn-valider").addEventListener("click", function () {

  /* Fournisseur */
  document.getElementById("recap-nom").textContent =
    document.getElementById("nom_fournisseur").value;

  document.getElementById("recap-tel").textContent =
    document.getElementById("tel_fournisseur").value;

  document.getElementById("recap-adresse").textContent =
    document.getElementById("adresse_fournisseur").value;

  /* Produits */
  const recap = document.getElementById("recap-body");
  recap.innerHTML = "";
  let totalQte = 0;

  document.querySelectorAll(".produit-row").forEach(row => {
    const qte = parseInt(row.querySelector(".qte").value || 0);
    if (qte <= 0) return;

    const categorie = row.children[0].textContent;
    const produit = row.children[1].textContent;

    totalQte += qte;

    recap.innerHTML += `
      <tr>
        <td>${categorie}</td>
        <td>${produit}</td>
        <td>${qte}</td>
      </tr>
    `;
  });

  document.getElementById("total-qte").textContent = totalQte;
});

/* écouteurs */
document.querySelectorAll(".qte")
  .forEach(input => input.addEventListener("input", verifierCommande));

verifierCommande();
</script>

{% endblock %}
