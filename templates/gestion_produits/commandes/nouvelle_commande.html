{% extends 'admin.html' %}
{% block contents %}

<h2>GESTION DES COMMANDES</h2>
<hr>

{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }} alert-dismissible fade show">
      {{ m }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<form method="post" id="form-commande">
  {% csrf_token %}

  <!-- ================= FOURNISSEUR ================= -->
  <div class="form-group mb-3">
    <label>Nom complet du Fournisseur</label>
    <input type="text" class="form-control" name="nom_complet_fournisseur" required>
  </div>

  <div class="form-group mb-3">
    <label>T√©l√©phone</label>
    <input type="text"
           class="form-control"
           name="telephone_fournisseur"
           pattern="[0-9+ ]+"
           maxlength="15"
           required>
  </div>

  <div class="form-group mb-3">
    <label>Adresse</label>
    <input type="text" class="form-control" name="adresse_fournisseur" required>
  </div>

  <!-- ================= RECHERCHE ================= -->
  <div class="mb-3">
    <input id="search" class="form-control" placeholder="Rechercher produit (nom ou cat√©gorie)">
  </div>

  <!-- ================= TABLE PRODUITS ================= -->
  <table class="table table-bordered" id="table-produits">
    <thead class="table-dark">
      <tr>
        <th>Cat√©gorie</th>
        <th>Produit</th>
        <th>Quantit√© √† commander</th>
      </tr>
    </thead>

    <tbody>
      {% for p in produits_data %}
      <tr class="produit-row">

        <td>{{ p.produit.categorie.desgcategorie }}</td>
        <td>{{ p.produit.desgprod }}</td>

        <td>
          <!-- üîí QUANTIT√â S√âCURIS√âE -->
          <input type="text"
                 name="quantite[]"
                 class="form-control qte only-numbers"
                 value="0"
                 inputmode="numeric"
                 autocomplete="off">

          <input type="hidden" name="produit_id[]" value="{{ p.produit.id }}">
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3" class="text-center">Aucun produit disponible.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button class="btn btn-success mt-3" id="btn-valider" disabled>
    Valider la commande
  </button>
</form>

<!-- ================= SCRIPTS ================= -->

<script>
/* üîí Bloquer lettres et caract√®res sp√©ciaux */
document.addEventListener("input", function (e) {
  if (e.target.classList.contains("only-numbers")) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  }
});

/* üîÑ Activer bouton si au moins une quantit√© > 0 */
function verifierCommande() {
  let actif = false;
  document.querySelectorAll(".qte").forEach(input => {
    if (parseInt(input.value || "0", 10) > 0) {
      actif = true;
    }
  });
  document.getElementById("btn-valider").disabled = !actif;
}

document.querySelectorAll(".qte").forEach(input => {
  input.addEventListener("input", verifierCommande);
});

/* üîç Recherche produit */
document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  document.querySelectorAll(".produit-row").forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

verifierCommande();
</script>

{% endblock %}
