{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>LISTE DES VENTES</title>

    <style>
        body { font-family: "Trebuchet MS", Arial, sans-serif; font-size: 12px; margin: 25px; color: #222; }
        h2, h3, h4 { text-align: center; margin: 0; }
        h3 { margin-top: 5px; color: #444; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #000; }
        th, td { padding: 6px; text-align: left; font-size: 11px; }
        th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
        img.photo-preview { max-width: 45px; max-height: 45px; border-radius: 4px; object-fit: contain; }

        .header-top { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .header-left, .header-right { font-size: 13px; line-height: 1.5; }
        .header-center { text-align: center; flex: 1; }
        .header-center h2 { font-weight: bold; text-transform: uppercase; margin-bottom: 5px; color: #002060; }
        .logo { width: 130px; height: 70px; object-fit: contain; }
        .footer { margin-top: 25px; font-size: 11px; text-align: right; color: #555; }
        .total-row { font-weight: bold; background-color: #e6f7ff; text-align: right; }
    </style>
</head>

<body>

    <!-- ENTÊTE ENTREPRISE -->
    <div class="header-top">
        <div class="header-left">
            <strong>{{ nom_entreprise.nom_entrepriese|upper }}</strong><br>
            <strong>Adresse :</strong> {{ nom_entreprise.adresse }}<br>
            <strong>Contact :</strong> {{ nom_entreprise.contact1 }}{% if nom_entreprise.contact2 %} / {{ nom_entreprise.contact2 }}{% endif %}<br>
            {% if nom_entreprise.email %}
            <strong>Email :</strong> {{ nom_entreprise.email }}
            {% endif %}
        </div>

        <div class="header-center">
            {% if nom_entreprise.logo %}
                <img src="{{ nom_entreprise.logo.url }}" alt="Logo" class="logo"><br>
            {% endif %}
            <h2>LISTE DES VENTES EFFECTUÉES</h2>
        </div>

        <div class="header-right">
            <strong>IMPRESSION</strong><br>
            <em>{{ today|date:"d/m/Y" }}</em>
        </div>
    </div>

    <!-- TITRE -->
    <h3>Ventes du {{ date_debut }} au {{ date_fin }}</h3>

    <!-- TABLEAU PRINCIPAL DES VENTES -->
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Ref Vente</th>
                <th>Catégorie Produit</th>
                <th>Produit</th>
                <th>Qté</th>
                <th>Prix Vente</th>
                <th>Sous-total</th>
                {% if request.user.type_utilisateur != 'Gerante' %}
                <th>Bénéfice</th>
                {% endif %}
                <th>Date Vente</th>
                <th>Photo Produit</th>
            </tr>
        </thead>
        <tbody>
            {% if ventes_liste %}
                {% for vente_data in ventes_liste %}
                    {% for ligne in vente_data.lignes %}
                        <tr>
                            <td>{{ forloop.parentloop.counter }}.{{ forloop.counter }}</td>
                            <td>{{ vente_data.vente.code }}</td>
                            <td>{{ ligne.produit.categorie.desgcategorie }}</td>
                            <td>{{ ligne.produit.desgprod }}</td>
                            <td>{{ ligne.quantite }}</td>
                            <td>{{ ligne.prix }} GNF</td>
                            <td>{{ ligne.sous_total }} GNF</td>
                            {% if request.user.type_utilisateur != 'Gerante' %}
                            <td>{{ ligne.benefice }} GNF</td>
                            {% endif %}
                            <td>{{ ligne.vente.date_vente|date:"d/m/Y" }}</td>
                            <td>
                                {% if ligne.produit.photoprod %}
                                    <img src="{{ ligne.produit.photoprod.url }}" class="photo-preview">
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    <!-- Totaux par vente -->
                    <tr class="total-row">
                        <td colspan="4">Total Vente {{ vente_data.vente.code }} :</td>
                        <td>{{ total_quantite_produits|default:0  }}</td>
                        <td class="text-center">-</td>
                        <td>{{ vente_data.total_vente }} GNF</td>
                        {% if request.user.type_utilisateur != 'Gerante' %}
                        <td>{{ vente_data.benefice_vente }} GNF</td>
                        {% endif %}
                        <td colspan="2" class="text-center">-</td>
                    </tr>
                {% endfor %}
                {% if request.user.type_utilisateur != 'Gerante' %}
                <!-- Bénéfice global -->
                <tr class="total-row">
                    <td colspan="7">Bénéfice Global :</td>
                    <td>{{ benefice_global }} GNF</td>
                    <td colspan="2"></td>
                </tr>
                {% endif %}
            {% else %}
                <tr>
                    <td colspan="10" style="text-align:center;">Aucune vente enregistrée pour cette période.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
<br>
    <!-- TABLEAU DES VENTES PAR PRODUIT -->
    <h4 class="text-center mt-4">TOTAL DES VENTES PAR PRODUIT</h4>

    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>#</th>
                <th>Produit</th>
                <th>Quantité Vendue</th>
                <th>Montant Total (GNF)</th>
            </tr>
        </thead>
        <tbody>
            {% if total_par_produit %}
                {% for prod in total_par_produit %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ prod.produit__desgprod }}</td>
                    <td>{{ prod.total_quantite }}</td>
                    <td>{{ prod.total_montant|floatformat:"0" }} GNF</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" style="text-align:center;">Aucune vente par produit</td>
                </tr>
            {% endif %}
        </tbody>
        <tfoot>
            <tr style="font-weight:bold; background-color:#e6f7ff;">
                <td colspan="2" style="text-align:center;">Totaux :</td>
                <td>{{ total_quantite_produits|default:0 }}</td>
                <td>{{ total_montant_produits|floatformat:"0"|default:"0" }} GNF</td>
            </tr>
        </tfoot>
    </table>
<br>
    <!-- TABLEAU DES VENTES PAR CATEGORIE -->
    <h4 class="text-center mt-4">TOTAL DES VENTES PAR CATÉGORIE</h4>

    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>#</th>
                <th>Catégorie</th>
                <th>Quantité Vendue</th>
                <th>Montant Total (GNF)</th>
            </tr>
        </thead>
        <tbody>
            {% if total_par_categorie %}
                {% for cat in total_par_categorie %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ cat.produit__categorie__desgcategorie }}</td>
                    <td>{{ cat.total_quantite }}</td>
                    <td>{{ cat.total_montant|floatformat:"0" }} GNF</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" style="text-align:center;">Aucune vente par catégorie</td>
                </tr>
            {% endif %}
        </tbody>
        <tfoot>
            <tr style="font-weight:bold; background-color:#e6f7ff;">
                <td colspan="2" style="text-align:center;">Totaux :</td>
                <td>{{ total_quantite_categories|default:0 }}</td>
                <td>{{ total_montant_categories|floatformat:"0"|default:"0" }} GNF</td>
            </tr>
        </tfoot>
    </table>

    <!-- Signature -->
    <div style="margin-top: 50px; width: 100%; display: flex; justify-content: flex-end;">
        <div style="text-align: right;">
            <p>Le Responsable</p>
            <br><br><br>
            <p>______________________________</p>
        </div>
    </div>

    <div class="footer">
        Impression générée le : {{ today|date:"d/m/Y" }}
    </div>

</body>
</html>
