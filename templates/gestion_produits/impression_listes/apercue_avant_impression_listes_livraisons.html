{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>LISTE DES LIVRAISONS</title>

    <style>
        body {
            font-family: "Trebuchet MS", Arial, sans-serif;
            font-size: 12px;
            margin: 25px;
            color: #222;
        }

        h2, h3, h4 {
            text-align: center;
            margin: 0;
        }

        h4 {
            margin-top: 15px;
            color: #444;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table, th, td {
            border: 1px solid #000;
        }

        th, td {
            padding: 6px;
            font-size: 11px;
        }

        th {
            background-color: #f0f0f0;
            text-align: center;
            font-weight: bold;
        }

        img.photo-preview {
            max-width: 45px;
            border-radius: 4px;
        }

        @media print {
            body { margin: 0; }
            .no-print { display: none; }
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .header-left, .header-right {
            font-size: 13px;
            line-height: 1.5;
        }

        .header-center {
            text-align: center;
            flex: 1;
        }

        .header-center h2 {
            font-weight: bold;
            text-transform: uppercase;
            color: #002060;
        }

        .logo {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }

        .footer {
            margin-top: 30px;
            font-size: 11px;
            text-align: right;
            color: #555;
        }
    </style>
</head>

<body>

<!-- ================= ENTÊTE ENTREPRISE ================= -->
<div class="header-top">

    <div class="header-left">
        <strong>{{ nom_entreprise.nom_entrepriese|upper }}</strong><br>
        <strong>Adresse :</strong> {{ nom_entreprise.adresse }}<br>
        <strong>Contact :</strong> {{ nom_entreprise.contact1 }}
        {% if nom_entreprise.contact2 %} / {{ nom_entreprise.contact2 }}{% endif %}<br>
        {% if nom_entreprise.email %}
            <strong>Email :</strong> {{ nom_entreprise.email }}
        {% endif %}
    </div>

    <div class="header-center">
        {% if nom_entreprise.logo %}
            <img src="{{ nom_entreprise.logo.url }}" alt="Logo" class="logo"><br>
        {% endif %}
        <h2>LISTE DES LIVRAISONS</h2>
    </div>

    <div class="header-right">
        <strong>IMPRESSION</strong><br>
        <em>{{ today|date:"d/m/Y" }}</em>
    </div>

</div>

<!-- ================= TITRE ================= -->
<h3>CATALOGUE DES PRODUITS LIVRÉS</h3>
<h4>Date début : {{ date_debut }} | Date fin : {{ date_fin }}</h4>

<!-- ================= TOTAUX PAR CATÉGORIE ================= -->
<h4>Totaux par catégorie</h4>

<table>
    <thead>
        <tr>
            <th>Catégorie</th>
            <th>Nombre livraisons</th>
            <th>Total livré</th>
            <th>Total restant</th>
        </tr>
    </thead>
    <tbody>
        {% for cat in total_par_categorie %}
        <tr>
            <td>{{ cat.produits__categorie__desgcategorie }}</td>
            <td style="text-align:center;">{{ cat.nombre_livraisons }}</td>
            <td style="text-align:center;">{{ cat.total_qtelivree }}</td>
            <td style="text-align:center;">{{ cat.total_qte_restante }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4" style="text-align:center;">Aucune donnée</td>
        </tr>
        {% endfor %}
    </tbody>
                    <tfoot class="table-secondary">
            <tr>
                <th class="text-center">Totaux :</th>
                <th class="text-center">{{ total_livraison }}</th>
                <th class="text-center">{{ total_quantite_livrer }}</th>
                <th class="text-center">{{ total_quantite_restante }}</th>
                </tr>
            </tfoot>
</table>

<!-- ================= TOTAUX PAR PRODUIT ================= -->
<h4>Totaux par produit</h4>

<table>
    <thead>
        <tr>
            <th>Catégorie</th>
            <th>Réf produit</th>
            <th>Désignation</th>
            <th>Livraisons</th>
            <th>Total livré</th>
            <th>Total restant</th>
        </tr>
    </thead>
    <tbody>
        {% for elem in total_par_produit %}
        <tr>
            <td>{{ elem.produits__categorie__desgcategorie }}</td>
            <td style="text-align:center;">{{ elem.produits__refprod }}</td>
            <td>{{ elem.produits__desgprod }}</td>
            <td style="text-align:center;">{{ elem.nombre_livraisons }}</td>
            <td style="text-align:center;">{{ elem.total_qtelivree }}</td>
            <td style="text-align:center;">{{ elem.total_qte_restante }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="text-align:center;">Aucune donnée</td>
        </tr>
        {% endfor %}
    </tbody>

    
</table>

<!-- ================= LISTE DÉTAILLÉE DES LIVRAISONS ================= -->
<h4>Détails des livraisons</h4>

<table>
    <thead>
        <tr>
            <th>#</th>
            <th>Num livraison</th>
            <th>Num commande</th>
            <th>Réf produit</th>
            <th>Catégorie</th>
            <th>Désignation</th>
            <th>Qté commandée</th>
            <th>Qté livrée</th>
            <th>Qté restante</th>
            <th>PU</th>
            <th>Date</th>
            <th>Photo</th>
        </tr>
    </thead>
    <tbody>
        {% for elem in listes_livraisons %}
        <tr>
            <td style="text-align:center;">{{ forloop.counter }}</td>
            <td>{{ elem.numlivrer }}</td>
            <td>{{ elem.commande.numcmd }}</td>
            <td>{{ elem.produits.refprod }}</td>
            <td>{{ elem.produits.categorie.desgcategorie }}</td>
            <td>{{ elem.produits.desgprod }}</td>
            <td style="text-align:center;">{{ elem.commande.qtecmd }}</td>
            <td style="text-align:center;">{{ elem.qtelivrer }}</td>
            <td style="text-align:center;">{{ elem.qte_restante }}</td>
            <td style="text-align:right;">{{ elem.produits.pu }}</td>
            <td style="text-align:center;">{{ elem.datelivrer|date:"d/m/Y" }}</td>
            <td style="text-align:center;">
                {% if elem.produits.photoprod %}
                    <img src="{{ elem.produits.photoprod.url }}" class="photo-preview">
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="12" style="text-align:center;">Aucune livraison trouvée</td>
        </tr>
        {% endfor %}
    </tbody>

    <tfoot class="table-secondary fw-bold">
    <tr>
        <!-- Colonnes non concernées -->
        <th colspan="6" class="text-end">TOTAUX GÉNÉRAUX :</th>

        <!-- Quantité commandée -->
        <th class="text-center">
            {{ total_qtecmd }}
        </th>

        <!-- Quantité livrée -->
        <th class="text-center text-success">
            {{ total_quantite_livrer }}
        </th>

        <!-- Quantité restante -->
        <th class="text-center text-danger">
            {{ total_quantite_restante }}
        </th>

        <!-- Colonnes PU / Date / Actions -->
        <th colspan="3"></th>
    </tr>
</tfoot>

</table>

<!-- ================= SIGNATURE ================= -->
<div style="margin-top: 50px; display: flex; justify-content: flex-end;">
    <div style="text-align: right;">
        <p>Le Responsable</p>
        <br><br>
        <p>______________________________</p>
    </div>
</div>

<div class="footer">
    Impression générée le {{ today|date:"d/m/Y" }}
</div>

</body>
</html>
