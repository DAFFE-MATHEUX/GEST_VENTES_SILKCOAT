{% extends 'admin.html' %}
{% load static %}

{% block contents %}
<style>
    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }
    .table td, .table th {
        white-space: nowrap;
    }
    .table img {
        max-width: 60px;
        max-height: 60px;
        object-fit: contain;
    }
</style>

<div class="container mt-3">
    <h2>üìú Historique des Commandes et Livraisons</h2>
    <hr>

    {% if historique %}
    <div class="table-responsive overflow-auto">
        <table class="table table-striped table-bordered align-middle" style="min-width:1200px;">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Num√©ro Commande</th>
                    <th>Produit</th>
                    <th>Cat√©gorie</th>
                    <th>Qt√© Command√©e</th>
                    <th>Total Livr√©e</th>
                    <th>Qt√© Restante</th>
                    <th>Livraisons</th>
                </tr>
            </thead>
            <tbody>
                {% for item in historique %}
                <tr {% if item.qte_restante == 0 %}class="table-success"{% endif %}>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.commande.numcmd }}</td>
                    <td>{{ item.commande.produits.desgprod }}</td>
                    <td>{{ item.commande.produits.categorie.desgcategorie }}</td>
                    <td>{{ item.commande.qtecmd }}</td>
                    <td>{{ item.total_livree }}</td>
                    <td>
                        <span class="badge {% if item.qte_restante == 0 %}bg-success{% else %}bg-warning text-dark{% endif %}">
                            {{ item.qte_restante }}
                        </span>
                    </td>
                    <td>
                        {% if item.livraisons %}
                            <ul class="mb-0">
                                {% for liv in item.livraisons %}
                                    <li>
                                        {{ liv.datelivrer|date:"d/m/Y" }} : {{ liv.qtelivrer }} unit√©(s)
                                        {% if liv.lieu %}- {{ liv.lieu }}{% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <span class="text-muted">Aucune livraison</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-secondary">
                <tr>
                    <th colspan="4" class="text-end">Totaux :</th>
                    <th>{{ total_commandes }}</th>
                    <th>{{ total_livrees }}</th>
                    <th>{{ total_restantes }}</th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
        <p class="text-center text-muted mt-3">Aucune commande ou livraison enregistr√©e.</p>
    {% endif %}
</div>
{% endblock %}
