{% extends 'admin.html' %}
{% load static %}
{% block contents %}

<style>
    .table-responsive { overflow-x: auto; width: 100%; }
    .table td, .table th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    body { overflow-x: hidden; }
</style>

<div class="container-fluid">
    <h2 class="mb-3">üì¶ GESTION DES LIVRAISONS</h2>
    <hr>

    <!-- Messages -->
    {% if messages %}
        {% for mgs in messages %}
            <div class="alert {% if mgs.tags == 'success' %} alert-success {% elif mgs.tags == 'error' %} alert-danger {% else %} alert-info {% endif %}">
                {{ mgs }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Boutons -->
    <div class="mb-3 d-flex justify-content-between">
        <a href="{% url 'produits:choix_par_dates_livraisons_impression' %}" class="btn btn-primary">
            <i class="fa fa-print"></i> Imprimer PDF
        </a>
        <a href="{% url 'produits:reception_livraison' %}" class="btn btn-success">
            <i class="fa fa-plus"></i> Nouvelle R√©ception ?
        </a>
    </div>

    <!-- Filtre par date -->
    <form method="get" class="row g-3 mb-4" action="{% url 'produits:filtrer_listes_livraisons' %}">
        <div class="col-md-3">
            <label class="form-label">Date D√©but</label>
            <input type="date" class="form-control" name="date_debut" value="{{ date_debut|default:'' }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Date Fin</label>
            <input type="date" class="form-control" name="date_fin" value="{{ date_fin|default:'' }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">üîç Filtrer</button>
            <a href="{% url 'produits:listes_des_livraisons' %}" class="btn btn-secondary w-100 ms-2">
                <i class="fa fa-refresh"></i> R√©initialiser
            </a>
        </div>
    </form>

    {% if listes_livraisons %}
    <!-- Totaux par cat√©gorie -->
    <h4>Totaux par Cat√©gorie</h4>
    <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Cat√©gorie</th>
                    <th>Total Quantit√© Livr√©e</th>
                    <th>Quantit√© Restante</th>
                    <th>Nombre de Livraisons</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in total_par_categorie %}
                <tr>
                    <td>{{ cat.produits__categorie__desgcategorie }}</td>
                    <td>{{ cat.total_qtelivree }}</td>
                    <td>{{ cat.total_qte_restante }}</td>
                    <td>{{ cat.nombre_livraisons }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center">Aucune livraison.</td></tr>
                {% endfor %}
            </tbody>
                <tfoot class="table-secondary">
            <tr>
                <th class="text-center">Totaux :</th>
                <th class="text-center">{{ total_quantite_livrer }}</th>
                <th class="text-center">{{ total_quantite_restante }}</th>
                <th class="text-center">{{ total_livraison }}</th>
                </tr>
            </tfoot>
        </table>

    </div>

    <h5 class="mt-4">üì¶ R√©capitulatif par produit</h5>

<table class="table table-bordered table-sm">
    <thead class="table-dark">
        <tr>
            <th>Produit</th>
            <th>Cat√©gorie</th>
            <th>Livraisons</th>
            <th>Qt√© command√©e</th>
            <th>Qt√© livr√©e</th>
            <th>Qt√© restante</th>
        </tr>
    </thead>
    <tbody>
        {% for prod in total_par_produit %}
        <tr>
            <td>{{ prod.produits__desgprod }}</td>
            <td>{{ prod.produits__categorie__desgcategorie }}</td>
            <td>{{ prod.nombre_livraisons }}</td>
            <td>{{ prod.total_qtecmd }}</td>
            <td>{{ prod.total_qtelivree }}</td>
            <td class="fw-bold text-danger">
                {{ prod.total_qte_restante }}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted">
                Aucune livraison
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>


    <!-- Tableau principal des livraisons -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Num Livraison</th>
                    <th>Num Commande</th>
                    <th>Cat√©gorie</th>
                    <th>R√©f Produit</th>
                    <th>D√©signation</th>
                    <th>Quantit√© Command√©e</th>
                    <th>Quantit√© Livr√©e</th>
                    <th>Quantit√© Restante</th>
                    <th>Prix Unitaire</th>
                    <th>Date Livraison</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for elem in listes_livraisons %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ elem.numlivrer }}</td>
                    <td>{{ elem.commande.numcmd }}</td>
                    <td>{{ elem.produits.categorie.desgcategorie }}</td>
                    <td>{{ elem.produits.refprod }}</td>
                    <td>{{ elem.produits.desgprod }}</td>
                    <td>{{ elem.commande.qtecmd }}</td>
                    <td>{{ elem.qtelivrer }}</td>
                    <td>{{ elem.qte_restante }}</td>
                    <td>{{ elem.produits.pu }}</td>
                    <td>{{ elem.datelivrer|date:'d/m/Y' }}</td>
                    <td>
                        <a class="btn btn-primary btn-sm" href="{% url 'produits:consulter_produit' elem.produits.id %}" title="Voir"><i class="fa fa-eye"></i></a>
                            <button class="btn btn-danger btn-sm btn-produit-sup"
                                    data-id="{{ elem.id }}"
                                    data-toggle="modal"
                                    data-target="#supprimer">
                                <i class="fa fa-trash"></i>
                            </button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="12" class="text-center">Aucune livraison enregistr√©e.</td></tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-secondary fw-bold">
    <tr>
        <!-- Colonnes non concern√©es -->
        <th colspan="6" class="text-center">TOTAUX G√âN√âRAUX :</th>

        <!-- Quantit√© command√©e -->
        <th class="text-center">
            {{ total_qtecmd }}
        </th>

        <!-- Quantit√© livr√©e -->
        <th class="text-center text-success">
            {{ total_quantite_livrer }}
        </th>

        <!-- Quantit√© restante -->
        <th class="text-center text-danger">
            {{ total_quantite_restante }}
        </th>

        <!-- Colonnes PU / Date / Actions -->
        <th colspan="3" class="text-center">-</th>
    </tr>
</tfoot>

        </table>
    </div>

    <!-- Pagination -->
    <div class="mt-4 d-flex justify-content-center">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if listes_livraisons.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page=1">&laquo; Premi√®re</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ listes_livraisons.previous_page_number }}">Pr√©c√©dent</a></li>
                {% endif %}
                <li class="page-item active"><span class="page-link">Page {{ listes_livraisons.number }} / {{ listes_livraisons.paginator.num_pages }}</span></li>
                {% if listes_livraisons.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ listes_livraisons.next_page_number }}">Suivant</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ listes_livraisons.paginator.num_pages }}">Derni√®re &raquo;</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% elif listes_livraisons_filtre %}

            <!-- Totaux par cat√©gorie -->
    <h4>Totaux par Cat√©gorie</h4>
    <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Cat√©gorie</th>
                    <th>Total Quantit√© Livr√©e</th>
                    <th>Quantit√© Restante</th>
                    <th>Nombre de Livraisons</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in total_par_categorie %}
                <tr>
                    <td>{{ cat.produits__categorie__desgcategorie }}</td>
                    <td>{{ cat.total_qtelivree }}</td>
                    <td>{{ cat.total_qte_restante }}</td>
                    <td>{{ cat.nombre_livraisons }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center">Aucune livraison.</td></tr>
                {% endfor %}
            </tbody>
                <tfoot class="table-secondary">
            <tr>
                <th class="text-center">Totaux :</th>
                <th class="text-center">{{ total_quantite_livrer }}</th>
                <th class="text-center">{{ total_quantite_restante }}</th>
                <th class="text-center">{{ total_livraison }}</th>
                </tr>
            </tfoot>
        </table>

    </div>
        <h5 class="mt-4">üì¶ R√©capitulatif par produit</h5>

<table class="table table-bordered table-sm">
    <thead class="table-dark">
        <tr>
            <th>Produit</th>
            <th>Cat√©gorie</th>
            <th>Livraisons</th>
            <th>Qt√© command√©e</th>
            <th>Qt√© livr√©e</th>
            <th>Qt√© restante</th>
        </tr>
    </thead>
    <tbody>
        {% for prod in total_par_produit %}
        <tr>
            <td>{{ prod.produits__desgprod }}</td>
            <td>{{ prod.produits__categorie__desgcategorie }}</td>
            <td>{{ prod.nombre_livraisons }}</td>
            <td>{{ prod.total_qtecmd }}</td>
            <td>{{ prod.total_qtelivree }}</td>
            <td class="fw-bold text-danger">
                {{ prod.total_qte_restante }}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted">
                Aucune livraison
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

    <!-- Tableau principal des livraisons -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Num Livraison</th>
                    <th>Num Commande</th>
                    <th>Cat√©gorie</th>
                    <th>R√©f Produit</th>
                    <th>D√©signation</th>
                    <th>Quantit√© Command√©e</th>
                    <th>Quantit√© Livr√©e</th>
                    <th>Quantit√© Restante</th>
                    <th>Prix Unitaire</th>
                    <th>Date Livraison</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for elem in listes_livraisons_filtre %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ elem.numlivrer }}</td>
                    <td>{{ elem.commande.numcmd }}</td>
                    <td>{{ elem.produits.categorie.desgcategorie }}</td>
                    <td>{{ elem.produits.refprod }}</td>
                    <td>{{ elem.produits.desgprod }}</td>
                    <td>{{ elem.commande.qtecmd }}</td>
                    <td>{{ elem.qtelivrer }}</td>
                    <td>{{ elem.qte_restante }}</td>
                    <td>{{ elem.produits.pu }}</td>
                    <td>{{ elem.datelivrer|date:'d/m/Y' }}</td>
                    <td>
                        <a class="btn btn-primary btn-sm" href="{% url 'produits:consulter_produit' elem.produits.id %}" title="Voir"><i class="fa fa-eye"></i></a>
                            <button class="btn btn-danger btn-sm btn-produit-sup"
                                    data-id="{{ elem.id }}"
                                    data-toggle="modal"
                                    data-target="#supprimer">
                                <i class="fa fa-trash"></i>
                            </button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="12" class="text-center">Aucune livraison enregistr√©e.</td></tr>
                {% endfor %}
            </tbody>
                        <tfoot class="table-secondary fw-bold">
    <tr>
        <!-- Colonnes non concern√©es -->
        <th colspan="6" class="text-center">TOTAUX G√âN√âRAUX :</th>

        <!-- Quantit√© command√©e -->
        <th class="text-center">
            {{ total_qtecmd }}
        </th>

        <!-- Quantit√© livr√©e -->
        <th class="text-center text-success">
            {{ total_quantite_livrer }}
        </th>

        <!-- Quantit√© restante -->
        <th class="text-center text-danger">
            {{ total_quantite_restante }}
        </th>

        <!-- Colonnes PU / Date / Actions -->
        <th colspan="3" class="text-center">-</th>
    </tr>
</tfoot>
        </table>
    </div>

    <!-- Pagination -->
    <div class="mt-4 d-flex justify-content-center">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if listes_livraisons_filtre.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page=1">&laquo; Premi√®re</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ listes_livraisons_filtre.previous_page_number }}">Pr√©c√©dent</a></li>
                {% endif %}
                <li class="page-item active"><span class="page-link">Page {{ listes_livraisons_filtre.number }} / {{ listes_livraisons_filtre.paginator.num_pages }}</span></li>
                {% if listes_livraisons_filtre.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ listes_livraisons_filtre.next_page_number }}">Suivant</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ listes_livraisons_filtre.paginator.num_pages }}">Derni√®re &raquo;</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>

    {% endif %}

<!-- ================= MODAL SUPPRESSION ================= -->
<div class="modal fade" id="supprimer">
<div class="modal-dialog">
<div class="modal-content">
<form method="POST" action="{% url 'produits:supprimer_livraisons' %}">
{% csrf_token %}
<div class="modal-header bg-danger">
    <h4>SUPPRESSION</h4>
</div>
<div class="modal-body">
    <input type="hidden" name="id_supprimer" id="id_supprimer">
    Confirmer la suppression ?
</div>
<div class="modal-footer">
    <button class="btn btn-default" data-dismiss="modal">Annuler</button>
    <button class="btn btn-danger">Supprimer</button>
</div>
</form>
</div>
</div>
</div>

</div>

<script>
    // Modal suppression
document.querySelectorAll('.btn-produit-sup').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('id_supprimer').value = btn.dataset.id;
    });
});


    // Faire dispara√Ætre les messages apr√®s 4s
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(el => {
            el.style.transition = "opacity 0.5s";
            el.style.opacity = 0;
            setTimeout(() => el.remove(), 500);
        });
    }, 4000);
</script>

{% endblock %}
