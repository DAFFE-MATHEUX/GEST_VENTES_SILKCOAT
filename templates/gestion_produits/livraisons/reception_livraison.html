{% extends 'admin.html' %}
{% block contents %}

<h2 class="mb-3">üì¶ R√©ception des commandes</h2>
<hr>

<form method="post" id="form-reception">
  {% csrf_token %}

  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Commande</th>
          <th>Date Cmd</th>
          <th>Produit</th>
          <th>Fournisseur</th>
          <th>Qt√© command√©e</th>
          <th>D√©j√† livr√©e</th>
          <th>Restante</th>
          <th>Qt√© Livr√©e</th>
          <th>Qt√© √† Annuler</th>
        </tr>
      </thead>

      <tbody>
        {% for item in commandes %}
        <tr {% if item.qte_restante == 0 %}class="table-success"{% endif %}>
          <td>{{ forloop.counter }}</td>
          <td>{{ item.commande.numcmd }}</td>
          <td>{{ item.commande.datecmd }}</td>
          <td>{{ item.commande.produits.desgprod }}</td>
          <td>{{ item.commande.nom_complet_fournisseur }}</td>
          <td>{{ item.commande.qtecmd }}</td>
          <td><span class="badge bg-info">{{ item.total_livree }}</span></td>
          <td>
            <span class="badge {% if item.qte_restante == 0 %}bg-success{% else %}bg-warning text-dark{% endif %}">
              {{ item.qte_restante }}
            </span>
          </td>

          {% if item.qte_restante > 0 %}
          <!-- üîπ Saisie quantit√© livr√©e -->
          <td>
            <input type="text"
                   name="qte_livree[]"
                   class="form-control qte-livree only-numbers"
                   value="0"
                   data-max="{{ item.qte_restante }}"
                   inputmode="numeric"
                   autocomplete="off">
            <input type="hidden" name="commande_id[]" value="{{ item.commande.id }}">
          </td>

          <!-- üîπ Saisie quantit√© √† annuler -->
          <td>
            <input type="text"
                   name="qte_annuler_{{ item.commande.id }}"
                   class="form-control qte-annuler only-numbers"
                   value="0"
                   data-max="{{ item.qte_restante }}"
                   inputmode="numeric"
                   autocomplete="off">
          </td>
          {% else %}
          <td colspan="2">
            <input type="hidden" name="qte_livree[]" value="0">
            <input type="hidden" name="commande_id[]" value="{{ item.commande.id }}">
            ‚úî Livraison compl√®te
          </td>
          {% endif %}

        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-muted">
            Aucune commande √† r√©ceptionner
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if commandes %}
  <div class="mt-3">
    <button type="submit" class="btn btn-success" id="btn-enregistrer" disabled>
      üíæ Enregistrer la livraison
    </button>
  </div>
  {% endif %}
</form>

<!-- ================= SCRIPTS ================= -->
<script>
/* üîí Bloquer lettres & caract√®res sp√©ciaux */
document.addEventListener("input", function (e) {
  if (e.target.classList.contains("only-numbers")) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  }
});

/* üîÑ Contr√¥le des quantit√©s livr√©es et annul√©es */
function verifierReception() {
  let actif = false;

  document.querySelectorAll("tr").forEach(row => {
    const inputLivree = row.querySelector(".qte-livree");
    const inputAnnuler = row.querySelector(".qte-annuler");

    if (!inputLivree || !inputAnnuler) return;

    const max = parseInt(inputLivree.dataset.max, 10);

    let valLivree = parseInt(inputLivree.value || "0", 10);
    let valAnnuler = parseInt(inputAnnuler.value || "0", 10);

    // üîπ Ne pas d√©passer la quantit√© restante
    if (valLivree > max) {
      valLivree = max;
      inputLivree.value = max;
    }
    if (valAnnuler > max) {
      valAnnuler = max;
      inputAnnuler.value = max;
    }

    // üîπ Somme livr√©e + annul√©e ne doit pas d√©passer le reste
    if (valLivree + valAnnuler > max) {
      const diff = max - valAnnuler;
      valLivree = diff >= 0 ? diff : 0;
      inputLivree.value = valLivree;
    }

    // üîπ Activer bouton si une action > 0
    if (valLivree > 0 || valAnnuler > 0) {
      actif = true;
    }
  });

  document.getElementById("btn-enregistrer").disabled = !actif;
}

// üîπ Attacher l‚Äô√©v√©nement aux champs
document.querySelectorAll(".qte-livree, .qte-annuler").forEach(input => {
  input.addEventListener("input", verifierReception);
});

verifierReception();
</script>

{% endblock %}
