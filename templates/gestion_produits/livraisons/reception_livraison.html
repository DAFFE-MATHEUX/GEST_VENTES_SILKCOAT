{% extends 'admin.html' %}
{% block contents %}

<h2 class="mb-3">üì¶ R√©ception des commandes</h2>
<hr>

<form method="post" id="form-reception">
  {% csrf_token %}

  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Commande</th>
          <th>Date Cmd</th>
          <th>Produit</th>
          <th>Fournisseur</th>
          <th>Qt√© command√©e</th>
          <th>D√©j√† livr√©e</th>
          <th>Restante</th>
          <th>Qt√© Livr√©e</th>
        </tr>
      </thead>

      <tbody>
        {% for item in commandes %}
        <tr {% if item.qte_restante == 0 %}class="table-success"{% endif %}>

          <td>{{ forloop.counter }}</td>
          <td>{{ item.commande.numcmd }}</td>
          <td>{{ item.commande.datecmd }}</td>
          <td>{{ item.commande.produits.desgprod }}</td>
          <td>{{ item.commande.nom_complet_fournisseur }}</td>
          <td>{{ item.commande.qtecmd }}</td>

          <td>
            <span class="badge bg-info">{{ item.total_livree }}</span>
          </td>

          <td>
            <span class="badge {% if item.qte_restante == 0 %}bg-success{% else %}bg-warning text-dark{% endif %}">
              {{ item.qte_restante }}
            </span>
          </td>

          {% if item.qte_restante > 0 %}
          <td>
            <!-- üîí INPUT TEXTE S√âCURIS√â -->
            <input type="text"
                   name="qte_livree[]"
                   class="form-control qte-livree only-numbers"
                   value="0"
                   data-max="{{ item.qte_restante }}"
                   inputmode="numeric"
                   autocomplete="off">

            <input type="hidden" name="commande_id[]" value="{{ item.commande.id }}">
          </td>
          {% else %}
          <td>
            <input type="hidden" name="qte_livree[]" value="0">
            <input type="hidden" name="commande_id[]" value="{{ item.commande.id }}">
            ‚úî Livraison compl√®te
          </td>
          {% endif %}

        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted">
            Aucune commande √† r√©ceptionner
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if commandes %}
  <div class="mt-3">
    <button type="submit" class="btn btn-success" id="btn-enregistrer" disabled>
      üíæ Enregistrer la livraison
    </button>
  </div>
  {% endif %}
</form>

<!-- ================= SCRIPTS ================= -->
<script>
/* üîí Bloquer lettres & caract√®res sp√©ciaux */
document.addEventListener("input", function (e) {
  if (e.target.classList.contains("only-numbers")) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  }
});

/* üîÑ Contr√¥le quantit√© livr√©e */
function verifierReception() {
  let actif = false;

  document.querySelectorAll(".qte-livree").forEach(input => {
    let val = parseInt(input.value || "0", 10);
    const max = parseInt(input.dataset.max, 10);

    if (val > max) {
      val = max;
      input.value = max;
    }

    if (val > 0) {
      actif = true;
    }
  });

  document.getElementById("btn-enregistrer").disabled = !actif;
}

document.querySelectorAll(".qte-livree").forEach(input => {
  input.addEventListener("input", verifierReception);
});

verifierReception();
</script>

{% endblock %}
