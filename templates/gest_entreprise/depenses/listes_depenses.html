{% extends 'admin.html' %}
{% load static %}
{% block contents %}

<style>
  .table-responsive { overflow-x: auto; width: 100%; }
  .table td, .table th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
  .table img { max-width: 60px; max-height: 60px; object-fit: contain; }
  body { overflow-x: hidden; }
  .text-right { text-align: right; }
  .mb-3 { margin-bottom: 15px; }
  .modal-header { padding: 15px; border-bottom: 1px solid #ddd; }
  .modal-title { font-weight: bold; }
  .modal-header.bg-danger { background: #dc3545; color: white; }
  .modal-header.bg-warning { background: #ffc107; color: #212529; }
  .btn-close { display: none; }
  .modal-lg { width: 40%; max-width: 900px; }
</style>

<div id="page-wrapper">
  <div id="page-inner">

    <div class="row">
      <div class="col-md-12">
        <h2>GESTION DES D√âPENSES</h2>
      </div>
    </div>
    <br>

    {% if messages %}
      {% for mgs in messages %}
        <div class="alert 
            {% if mgs.tags == 'success' %} alert-success 
            {% elif mgs.tags == 'error' %} alert-danger 
            {% else %} alert-info 
            {% endif %}">
            {{ mgs }}
        </div>
      {% endfor %}
    {% endif %}

        <form method="get" class="row g-3 mb-4" action="{% url 'filtrer_listes_depenses' %}">

        <div class="col-md-3">
            <label for="date_debut" class="form-label">Date D√©but</label>
            <input type="date" class="form-control" id="date_debut" name="date_debut" value="{{ date_debut }}" required>
        </div>

        <div class="col-md-3">
            <label for="date_fin" class="form-label">Date Fin</label>
            <input type="date" class="form-control" id="date_fin" name="date_fin" value="{{ date_fin }}" required>
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
                üîç Filtrer
            </button>
             <a href="{% url 'liste_depense'  %}" class="btn btn-primary w-100">
                <i class="fa fa-refresh"></i> Annuler
            </a>
        </div>

         <div class="col-md-3 d-flex align-items-end">

             <a href="{% url 'choix_listes_impression_depenses'  %}" class="btn btn-primary w-100">
                <i class="fa fa-print"></i> Imprimer la Liste
            </a>
        </div>

          
    </form>
<br>

 <div class="row mb-3">
      <div class="col-md-6">
        <small class="text-muted" style="font-size: 20px; font-weight: bold;">
          Total D√©penses :
          <strong>{{ total_depenses }}</strong>
        </small>
      </div>
      <div class="col-md-6 text-right">
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#nouvelle_depense">
          <i class="fa fa-plus"></i> NOUVELLE D√âPENSE
        </button>
      </div>
    </div>
    
{% if liste_depenses %}

    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>D√©signation</th>
            <th>Destin√© √†</th>
            <th>R√¥le Utilisateur</th>
            <th>Utilisateur</th>
            <th>Montant</th>
            <th>Date</th>
            <th>Recu</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for depense in liste_depenses %}
          <tr>
            <td>{{ forloop.counter}}</td>
            <td>{{ depense.designation }}</td>
            <td>{{ depense.destine_a }}</td>
            <td>{{ depense.utilisateur|default:'Administrateur' }}</td>
            <td>{{ depense.utilisateur.get_full_name }}</td>
            <td>{{ depense.montant }}</td>
            <td>{{ depense.date_operation|date:"d/m/Y" }}</td>
            <td>
              <a href="{% url 'recu_depense' depense.id %}" class="btn btn-primary">  <i class="fa fa-print"></i> </a>
             
            </td>
            <td class="text-center">
              <!-- Voir -->
              <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#voir_depense"
                data-utilisateur="{{ depense.utilisateur.get_full_name|default:'Administrateur' }}"
                data-designation="{{ depense.designation }}"
                data-montant="{{ depense.montant }}"
                data-destine="{{ depense.destine_a }}"
                data-date="{{ depense.date_operation|date:'Y-m-d' }}">
                <i class="fa fa-eye"></i>
              </button>

              <!-- Modifier -->
              <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#modifier_depense"
                data-id="{{ depense.id }}"
                data-designation="{{ depense.designation }}"
                data-destine="{{ depense.destine_a }}"
                data-montant="{{ depense.montant }}">
                <i class="fa fa-pencil"></i>
              </button>

              <!-- Supprimer -->
              <button type="button" class="btn btn-danger btn-sm btn-sup" data-toggle="modal" data-target="#supprimer_depense"
                data-id="{{ depense.id }}">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="11" class="text-center">Aucune d√©pense trouv√©e</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    <div class="row mt-4">
      <div class="col-md-8 offset-md-2">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            {% if liste_depenses.has_previous %}
              <li class="page-item"><a class="page-link" href="?page=1">&laquo; Premi√®re</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ liste_depenses.previous_page_number }}">Pr√©c√©dent</a></li>
            {% endif %}
            <li class="page-item active"><span class="page-link">Page {{ liste_depenses.number }} / {{ liste_depenses.paginator.num_pages }}</span></li>
            {% if liste_depenses.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ liste_depenses.next_page_number }}">Suivant</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ liste_depenses.paginator.num_pages }}">Derni√®re &raquo;</a></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
{% elif listes_depenses_pagine %}
   

    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>D√©signation</th>
            <th>Destin√© √†</th>
            <th>Utilisateur</th>
            <th>Montant</th>
            <th>Date</th>
            <th>Recu Depenses</th>
            <th>Recu Global</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for depense in listes_depenses_pagine %}
          <tr>
            <td>{{ forloop.counter}}</td>
            <td>{{ depense.designation }}</td>
            <td>{{ depense.destine_a }}</td> 
            <td>{{ depense.utilisateur|default:'Administrateur' }}</td>
            <td>{{ depense.montant }}</td>
            <td>{{ depense.date_operation|date:"Y-m-d" }}</td>
              <td>
              <a href="{% url 'recu_depense' depense.id %}" class="btn btn-primary">  <i class="fa fa-print"></i> </a>
             
            </td>

            <td>
              {% if date_debut and date_fin %}
                  <a href="{% url 'recu_depense_global_interval' %}?date_debut={{ date_debut }}&date_fin={{ date_fin }}" class="btn btn-primary">
                      Global <i class="fa fa-print"></i>
                  </a>
              {% else %}
                  <button class="btn btn-primary" disabled title="S√©lectionnez d'abord les dates">
                      Global <i class="fa fa-print"></i>
                  </button>
              {% endif %}
             
            </td>
            <td class="text-center">
              <!-- Voir -->
              <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#voir_depense"
                data-utilisateur="{{ depense.utilisateur.get_full_name|default:'Administrateur' }}"
                data-designation="{{ depense.designation }}"
                data-montant="{{ depense.montant }}"
                data-destine="{{ depense.destine_a }}"
                data-personnel="{{ depense.personnel }}"
                data-date="{{ depense.date_operation|date:'Y-m-d' }}">
                <i class="fa fa-eye"></i>
              </button>

              <!-- Modifier -->
              <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#modifier_depense"
                data-id="{{ depense.id }}"
                data-designation="{{ depense.designation }}"
                data-destine="{{ depense.destine_a }}"
                data-montant="{{ depense.montant }}">
                <i class="fa fa-pencil"></i>
              </button>

              <!-- Supprimer -->
              <button type="button" class="btn btn-danger btn-sm btn-sup" data-toggle="modal" data-target="#supprimer_depense"
                data-id="{{ depense.id }}">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="11" class="text-center">Aucune d√©pense trouv√©e</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">

    {% if listes_depenses_pagine.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{{ query_params }}&page=1">
          &laquo; Premi√®re
        </a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?{{ query_params }}&page={{ listes_depenses_pagine.previous_page_number }}">
          Pr√©c√©dent
        </a>
      </li>
    {% endif %}

    <li class="page-item active">
      <span class="page-link">
        Page {{ listes_depenses_pagine.number }} /
        {{ listes_depenses_pagine.paginator.num_pages }}
      </span>
    </li>

    {% if listes_depenses_pagine.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{{ query_params }}&page={{ listes_depenses_pagine.next_page_number }}">
          Suivant
        </a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?{{ query_params }}&page={{ listes_depenses_pagine.paginator.num_pages }}">
          Derni√®re &raquo;
        </a>
      </li>
    {% endif %}

  </ul>
</nav>


{% endif %}
  </div> <!-- fin #page-inner -->

  <!-- Modal Nouvelle D√©pense -->
  <div class="modal fade" id="nouvelle_depense" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger">
          <h4 class="modal-title text-center">NOUVELLE D√âPENSE</h4>
        </div>
        <form method="post" action="{% url 'nouvelle_depense' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="form-group"><label>D√©signation</label><input type="text" name="designation" class="form-control" required></div>
            <div class="form-group"><label>Destin√© √†</label><input type="text" name="destine_a" class="form-control" required></div>
            <div class="form-group"><label>Montant</label><input type="text" name="montant" class="form-control only-numbers" required></div>

          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Valider</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Voir D√©pense -->
  <div class="modal fade" id="voir_depense" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger"><h4 class="modal-title text-center">INFORMATIONS D√âTAILS</h4></div>
        <div class="modal-body">
          <div class="form-group"><label>D√©signation</label><input type="text" id="voir_designation" class="form-control" readonly></div>
          <div class="form-group"><label>Montant</label><input type="text" id="voir_montant" class="form-control" readonly></div>
          <div class="form-group"><label>Destin√© √†</label><input type="text" id="voir_destine" class="form-control" readonly></div>
          <div class="form-group"><label>Utilisateur</label><input type="text" id="voir_utilisateur" class="form-control" readonly></div>
          <div class="form-group"><label>Date</label><input type="text" id="voir_date" class="form-control" readonly></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modal Modifier D√©pense -->
  <div class="modal fade" id="modifier_depense" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-warning"><h4 class="modal-title">MODIFIER LA D√âPENSE</h4></div>
        <form method="post" action="{% url 'modifier_depense' %}">
          {% csrf_token %}
          <div class="modal-body">
            <input type="hidden" name="id_modif" id="modif_id">
            <div class="form-group"><label>D√©signation</label><input type="text" name="modif_designation" id="modif_designation" class="form-control" required></div>
            <div class="form-group"><label>Destin√© √†</label><input type="text" name="modif_destine" id="modif_destine" class="form-control" required></div>
            <div class="form-group"><label>Montant</label><input type="text" name="modif_montant" id="modif_montant" class="form-control only-numbers" required></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-warning"><i class="fa fa-edit"></i> Modifier</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Supprimer D√©pense -->
  <div class="modal fade" id="supprimer_depense" tabindex="-1" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger"><h4 class="modal-title">SUPPRIMER D√âPENSE</h4></div>
        <form method="post" action="{% url 'supprimer_depense' %}">
          {% csrf_token %}
          <div class="modal-body">
            <input type="hidden" name="id_supprimer" id="sup_id">
            <p>√ätes-vous s√ªr de vouloir supprimer cette d√©pense ?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-danger">Supprimer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div> <!-- fin #page-wrapper -->

<script>

    // =============================
  // ‚úÖ CORRECTION MAJEURE ICI
  // =============================
  // üîí Interdire lettres, symboles, espaces
  // ‚úî Autorise uniquement les chiffres (0-9)
  // ‚úî Fonctionne clavier + copier/coller
  // ‚úî Valable pour TOUS les champs ayant la classe "only-numbers"
  // =============================
  document.addEventListener("input", function (e) {
      if (e.target.classList.contains("only-numbers")) {
          e.target.value = e.target.value.replace(/[^0-9]/g, "");
      }
  });

  // Modal Voir
  document.querySelectorAll('button[data-target="#voir_depense"]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('voir_designation').value = btn.dataset.designation;
      document.getElementById('voir_montant').value = btn.dataset.montant;
      document.getElementById('voir_destine').value = btn.dataset.destine;
      document.getElementById('voir_utilisateur').value = btn.dataset.utilisateur||'';
      document.getElementById('voir_date').value = btn.dataset.date;
    });
  });

  // Modal Modifier
  document.querySelectorAll('button[data-target="#modifier_depense"]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('modif_id').value = btn.dataset.id;
      document.getElementById('modif_designation').value = btn.dataset.designation;
      document.getElementById('modif_destine').value = btn.dataset.destine;
      document.getElementById('modif_montant').value = btn.dataset.montant;
    });
  });

  // Modal Supprimer
  document.querySelectorAll('.btn-sup').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('sup_id').value = btn.dataset.id;
    });
  });

  // Faire dispara√Ætre les messages apr√®s 4 secondes
  setTimeout(() => {
    document.querySelectorAll('.alert').forEach(el => {
      el.style.transition = "opacity 0.5s";
      el.style.opacity = "0";
      setTimeout(() => el.remove(), 500);
    });
  }, 4000);
</script>

{% endblock %}
